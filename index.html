<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wholesale Menswear Collection | Pagus Menswear Turkey</title>
    <meta name="description" content="Premium wholesale menswear collection from Turkey. Suits, Tuxedos, and more.">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://*.googleusercontent.com; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://*.firebaseapp.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com; frame-src https://*.firebaseapp.com https://accounts.google.com;">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --color-black: #1a1a1a; --color-gold: #c9a962; --color-noble: #2c3e50; --font-display: 'Playfair Display', serif; --font-body: 'Montserrat', sans-serif; --site-max-width: 1400px; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: var(--font-body); color: var(--color-black); background: #fff; overflow-x: hidden; }
        .header { position: sticky; top: 0; width: 100%; z-index: 900; background: var(--color-noble); padding: 15px 0; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .header-inner { max-width: var(--site-max-width); margin: 0 auto; padding: 0 40px; }
        .logo-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .logo { font-family: var(--font-display); font-size: 1.6rem; color: #fff; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; text-decoration: none;}
        .soc-icons { display: flex; gap: 15px; align-items: center; }
        .soc-icons .social-icon { display: flex; align-items: center; justify-content: center; }
        .soc-icons .social-icon svg { width: 20px; height: 20px; fill: #fff; transition: 0.3s; }
        .soc-icons .social-icon:hover svg { fill: var(--color-gold); }
        .nav-list { display: flex; gap: 25px; list-style: none; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; width: 100%; justify-content: center; flex-wrap: wrap; }
        .nav-list a { color: #fff; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s; text-decoration: none; white-space: nowrap; padding: 10px 5px; }
        .nav-list a:hover { color: var(--color-gold); }
        .search-form { display: contents; }
        .search-box { display: flex; gap: 0; background: rgba(255,255,255,0.1); border-radius: 25px; overflow: hidden; }
        .search-box input { background: transparent; border: none; padding: 10px 18px; color: #fff; font-size: 0.9rem; width: 180px; outline: none; }
        .search-box input::placeholder { color: rgba(255,255,255,0.5); }
        .search-box button { background: var(--color-gold); border: none; padding: 10px 18px; color: var(--color-noble); font-weight: 700; cursor: pointer; transition: 0.3s; }
        .search-box button:hover { background: #d4b366; }
        .search-results-section { padding: 40px 20px; max-width: var(--site-max-width); margin: 0 auto; }
        .search-results-title { font-family: var(--font-display); font-size: 1.8rem; color: var(--color-noble); margin-bottom: 30px; text-align: center; }
        .search-results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
        .search-result-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08); cursor: pointer; transition: 0.3s; }
        .search-result-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
        .search-result-card img { width: 100%; aspect-ratio: 3/4; object-fit: cover; }
        .search-result-card .info { padding: 15px; text-align: center; }
        .search-result-card h4 { font-family: var(--font-display); font-size: 1rem; color: var(--color-noble); margin: 0 0 5px; }
        .search-result-card span { font-size: 0.8rem; color: var(--color-gold); }
        .page-title-area { background: #f9f9f9; padding: 40px 0 20px; text-align: center; border-bottom: 1px solid #eee; }
        .cat-title { font-family: var(--font-display); font-size: 2.5rem; text-transform: uppercase; color: var(--color-noble); margin-bottom: 20px; }
        .back-btn { display: inline-block; color: var(--color-gold); font-weight: 700; margin-bottom: 15px; cursor: pointer; border: 1px solid var(--color-gold); padding: 6px 18px; font-size: 0.8rem; transition: 0.3s; }
        .info-guide { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; max-width: 600px; margin: 0 auto 20px; padding: 15px; border-radius: 8px; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 10px; width: 90%; }
        .grid { max-width: var(--site-max-width); margin: 0 auto; padding: 40px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 40px; min-height: 400px; }
        .card { cursor: pointer; text-align: center; position: relative; }
        .img-box { aspect-ratio: 3/4; overflow: hidden; background: #eee; margin-bottom: 15px; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; opacity: 0; animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        .card:hover img { transform: scale(1.05); }
        .info-title { font-family: var(--font-display); font-size: 1.3rem; margin-bottom: 5px; color: var(--color-noble); }
        .heart-btn { position: absolute; top: 10px; right: 10px; width: 35px; height: 35px; background: rgba(255,255,255,0.9); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; color: #ccc; cursor: pointer; z-index: 10; border: none; }
        .heart-btn.active { color: #e74c3c; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); }
        .modal-content { height: 100vh; display: grid; grid-template-columns: 3fr 1fr; }
        .slider { position: relative; background: #000; display: flex; align-items: center; justify-content: center; height: 100%; user-select: none; }
        .main-img { max-height: 90vh; max-width: 95%; object-fit: contain; }
        .arrow { position: absolute; top: 50%; transform: translateY(-50%); color: #fff; font-size: 4rem; cursor: pointer; padding: 20px; opacity: 0.7; z-index: 2010; text-shadow: 0 0 10px rgba(0,0,0,0.5); background: transparent; border: none; }
        .arrow:hover { opacity: 1; color: var(--color-gold); }
        .prev { left: 0; } .next { right: 0; }
        .img-counter { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 700; pointer-events: none; }
        .side-info { background: #fff; padding: 60px; display: flex; flex-direction: column; justify-content: center; position: relative; overflow-y: auto; }
        .close { position: absolute; top: 25px; right: 35px; font-size: 45px; color: #fff; cursor: pointer; line-height: 1; z-index: 2020; }
        .private-label { background: var(--color-noble); padding: 80px 40px; text-align: center; color: #fff; margin-top: 60px; }
        .pl-title { font-family: var(--font-display); font-size: 2.5rem; color: var(--color-gold); margin-bottom: 20px; }
        .pl-btn { display: inline-block; background: var(--color-gold); color: #000; padding: 15px 40px; text-decoration: none; font-weight: 700; border-radius: 4px; }
        .footer { background: #000; color: #999; padding: 70px 40px; border-top: 1px solid #333; }
        .footer-grid { max-width: var(--site-max-width); margin: 0 auto; display: grid; grid-template-columns: 2fr 1fr; gap: 6rem; }
        .float-cart { position: fixed; bottom: 20px; right: 20px; z-index: 999; background: #25D366; color: #fff; padding: 12px 20px; border-radius: 50px; font-weight: 700; display: none; align-items: center; gap: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: none; cursor: pointer; font-family: var(--font-body); font-size: 1rem; }
        .float-cart:hover { background: #1da851; transform: scale(1.05); }
        .badges { display: flex; gap: 15px; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .badge-item { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 5px; font-size: 0.7rem; color: #666; font-weight: 600; text-transform: uppercase; }
        .badge-icon { font-size: 1.5rem; color: var(--color-noble); }
        /* FIX #11: Styled toast notification */
        .toast-notification { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px); background: var(--color-noble); color: #fff; padding: 12px 28px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; z-index: 9999; opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .toast-notification.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
        /* FIX #1: Carousel styles */
        .carousel-section { width: 100%; background: #000; position: relative; overflow: hidden; max-height: 500px; }
        .ss-slide { display: none; position: relative; cursor: pointer; }
        .ss-slide.active { display: block; }
        .ss-slide.ss-broken { display: none !important; }
        .ss-slide img { width: 100%; max-height: 500px; object-fit: cover; object-position: center top; }
        .ss-slide-info { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.7)); padding: 30px 20px 20px; text-align: center; }
        .ss-slide-info h4 { color: #fff; font-family: var(--font-display); font-size: 1.2rem; }
        .ss-slide-info span { color: var(--color-gold); font-size: 0.8rem; }
        .ss-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.1); border: none; color: #fff; font-size: 2rem; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; z-index: 10; }
        .ss-nav:hover { background: rgba(255,255,255,0.2); }
        .ss-nav.ss-prev { left: 15px; }
        .ss-nav.ss-next { right: 15px; }
        .ss-dots { position: absolute; bottom: 10px; right: 15px; background: rgba(0,0,0,0.5); color: #fff; padding: 4px 12px; border-radius: 15px; font-size: 0.8rem; }
        @media (max-width: 768px) {
            .header-inner { padding: 0 15px; }
            .logo-row { flex-wrap: wrap; gap: 10px; }
            .search-box { order: 3; width: 100%; margin-top: 10px; }
            .search-box input { flex: 1; width: auto; }
            .nav-list { gap: 10px; justify-content: center; } .nav-list a { font-size: 0.75rem; padding: 5px; }
            .grid { padding: 20px 10px; gap: 15px; grid-template-columns: 1fr 1fr; }
            .modal-content { display: flex; flex-direction: column; height: 100%; overflow-y: scroll; }
            .slider { height: 50vh; min-height: 300px; background: #000; flex-shrink: 0; }
            .side-info { padding: 30px 20px; height: auto; display: block !important; }
            .arrow { font-size: 3rem; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
            .prev { left: 10px; } .next { right: 10px; }
            .footer-grid { grid-template-columns: 1fr; gap: 30px; }
            .search-results-grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .carousel-section { max-height: 350px; }
            .ss-slide img { max-height: 350px; }
        }
        /* HERO SECTION */
        .hero { background: linear-gradient(135deg, var(--color-noble) 0%, #1a252f 100%); color: #fff; padding: 40px 20px; text-align: center; position: relative; }
        .hero-content { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; }
        .hero h2 { font-family: var(--font-display); font-size: 1.8rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .hero-tagline { color: var(--color-gold); font-size: 0.9rem; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 15px; font-weight: 600; }
        .hero p { display: none; }
        .hero-stats { display: flex; justify-content: center; gap: 50px; flex-wrap: wrap; margin-top: 20px; }
        .stat-item { text-align: center; }
        .stat-num { font-family: var(--font-display); font-size: 1.8rem; color: var(--color-gold); display: block; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: #aaa; margin-top: 3px; }
        @media (max-width: 768px) { .hero { padding: 30px 15px; } .hero h2 { font-size: 1.4rem; } .hero-stats { gap: 25px; } .stat-num { font-size: 1.5rem; } }
        /* AUTH UI */
        .auth-btn { background: transparent; border: 1px solid var(--color-gold); color: var(--color-gold); padding: 8px 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer; transition: 0.3s; font-family: var(--font-body); border-radius: 3px; white-space: nowrap; }
        .auth-btn:hover { background: var(--color-gold); color: var(--color-noble); }
        .user-menu { display: flex; align-items: center; gap: 12px; }
        .user-greeting { color: var(--color-gold); font-size: 0.8rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .logout-btn { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 14px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: 0.3s; font-family: var(--font-body); border-radius: 3px; }
        .logout-btn:hover { border-color: #e74c3c; color: #e74c3c; }
        /* AUTH MODAL */
        .auth-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 5000; justify-content: center; align-items: center; }
        .auth-overlay.visible { display: flex; }
        .auth-card { background: #fff; width: 420px; max-width: 92vw; border-radius: 8px; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.4); animation: authSlideUp 0.3s ease; }
        @keyframes authSlideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .auth-header { background: var(--color-noble); padding: 30px; text-align: center; }
        .auth-header h3 { font-family: var(--font-display); color: #fff; font-size: 1.4rem; margin-bottom: 5px; }
        .auth-header p { color: rgba(255,255,255,0.5); font-size: 0.8rem; }
        .auth-tabs { display: flex; border-bottom: 1px solid #eee; }
        .auth-tab { flex: 1; padding: 14px; text-align: center; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer; color: #aaa; border-bottom: 2px solid transparent; transition: 0.3s; background: none; border-top: none; border-left: none; border-right: none; font-family: var(--font-body); }
        .auth-tab.active { color: var(--color-noble); border-bottom-color: var(--color-gold); }
        .auth-body { padding: 30px; }
        .auth-field { margin-bottom: 18px; }
        .auth-field label { display: block; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: #666; margin-bottom: 6px; }
        .auth-field input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem; font-family: var(--font-body); transition: 0.3s; outline: none; }
        .auth-field input:focus { border-color: var(--color-gold); box-shadow: 0 0 0 3px rgba(201,169,98,0.15); }
        .auth-submit { width: 100%; padding: 14px; background: var(--color-noble); color: #fff; border: none; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: 0.3s; font-family: var(--font-body); border-radius: 4px; }
        .auth-submit:hover { background: #1a252f; }
        .auth-submit:disabled { opacity: 0.5; cursor: not-allowed; }
        .auth-divider { display: flex; align-items: center; gap: 15px; margin: 20px 0; color: #ccc; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .auth-divider::before, .auth-divider::after { content: ''; flex: 1; border-top: 1px solid #eee; }
        .google-btn { width: 100%; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; font-weight: 600; cursor: pointer; font-family: var(--font-body); display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; color: #333; }
        .google-btn:hover { background: #f8f8f8; border-color: #bbb; }
        .google-btn svg { width: 18px; height: 18px; }
        .auth-error { background: #fff5f5; border: 1px solid #fed7d7; color: #c53030; padding: 10px 15px; border-radius: 4px; font-size: 0.85rem; margin-bottom: 15px; display: none; }
        .auth-close { position: absolute; top: 15px; right: 20px; background: none; border: none; color: rgba(255,255,255,0.6); font-size: 1.8rem; cursor: pointer; z-index: 5001; line-height: 1; }
        .auth-close:hover { color: #fff; }
        /* PRICE TAGS */
        .price-tag { font-family: var(--font-display); font-size: 1.1rem; color: var(--color-gold); font-weight: 700; margin-top: 5px; }
        .price-login-hint { font-size: 0.75rem; color: #aaa; margin-top: 5px; cursor: pointer; text-decoration: underline; text-decoration-color: rgba(170,170,170,0.3); }
        .price-login-hint:hover { color: var(--color-gold); }
        .modal-price { font-family: var(--font-display); font-size: 2rem; color: var(--color-gold); margin: 15px 0; }
        .modal-price-hint { color: #999; font-size: 0.85rem; cursor: pointer; margin: 10px 0; }
        .modal-price-hint:hover { color: var(--color-gold); }
        .price-tier { font-size: 0.7rem; color: #999; text-transform: uppercase; letter-spacing: 1px; }
        /* COOKIE BANNER */
        .cookie-banner { position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-noble); color: #fff; padding: 18px 25px; z-index: 8000; display: none; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap; box-shadow: 0 -4px 20px rgba(0,0,0,0.3); font-size: 0.85rem; }
        .cookie-banner.visible { display: flex; }
        .cookie-banner p { max-width: 700px; line-height: 1.5; color: rgba(255,255,255,0.8); }
        .cookie-banner a { color: var(--color-gold); }
        .cookie-accept { background: var(--color-gold); color: var(--color-noble); border: none; padding: 10px 25px; font-weight: 700; font-size: 0.85rem; cursor: pointer; border-radius: 3px; font-family: var(--font-body); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }
        .cookie-accept:hover { background: #d4b366; }
        @media (max-width: 768px) {
            .auth-card { width: 100%; max-width: 100%; border-radius: 0; min-height: 100vh; display: flex; flex-direction: column; }
            .auth-body { flex: 1; }
            .user-greeting { max-width: 80px; font-size: 0.7rem; }
            .auth-btn { padding: 6px 12px; font-size: 0.7rem; }
        }
        /* SHOWCASE */
        .showcase-section { width: 100%; background: #1a1a1a; }
        .showcase-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; }
        .showcase-item { position: relative; aspect-ratio: 3/4; overflow: hidden; cursor: pointer; }
        .showcase-item:focus-visible { outline: 3px solid var(--color-gold); outline-offset: -3px; }
        .showcase-item img { width: 100%; height: 100%; object-fit: cover; object-position: top; transition: transform 0.5s ease; }
        .showcase-item:hover img { transform: scale(1.05); }
        .showcase-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(transparent, rgba(0,0,0,0.8)); padding: 40px 20px 25px; }
        .showcase-overlay span { color: #fff; font-family: var(--font-display); font-size: 1.1rem; text-transform: uppercase; letter-spacing: 2px; }
        .showcase-hero-img { width: 100%; display: block; max-height: 600px; object-fit: cover; object-position: center; }
        @media (max-width: 768px) { .showcase-grid { grid-template-columns: repeat(2, 1fr); } .showcase-overlay span { font-size: 0.8rem; letter-spacing: 1px; } .showcase-overlay { padding: 25px 15px 15px; } .showcase-hero-img { max-height: 300px; } }
    </style>
</head>
<body>
    <header class="header"><div class="header-inner">
        <div class="logo-row">
            <a href="index.html" class="logo">PAGUS</a>
            <!-- FIX #13: role="search" wrapper for accessibility -->
            <div role="search" class="search-form">
                <div class="search-box">
                    <input type="text" id="siteSearch" placeholder="Search products..." aria-label="Search products" onkeypress="if(event.key==='Enter')doSiteSearch()">
                    <button onclick="doSiteSearch()" aria-label="Search">&#128269;</button>
                </div>
            </div>
            <div class="soc-icons">
                <!-- Auth UI: shows login btn or user greeting -->
                <div id="authArea">
                    <button class="auth-btn" onclick="openAuthModal('login')">LOGIN</button>
                </div>
<a href="https://www.instagram.com/pagus_menswear/" target="_blank" rel="noopener" class="social-icon" title="Instagram"><svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>
<a href="#" id="waLink" target="_blank" rel="noopener" class="social-icon" title="WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></a>
<a href="https://www.linkedin.com/company/pagusmenswear/" target="_blank" rel="noopener" class="social-icon" title="LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
<a href="https://www.facebook.com/pagusmenswear/" target="_blank" rel="noopener" class="social-icon" title="Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>
            </div>
        </div>
        <nav><ul class="nav-list">
                <li><a href="?category=Wedding Suits">Wedding Suits</a></li>
                <li><a href="?category=Formal Suits">Formal Suits</a></li>
                <li><a href="?category=Shirts">Shirts</a></li>
                <li><a href="?category=Shoes">Shoes</a></li>
                <li><a href="?category=Accessories">Accessories</a></li>
                <li><a href="?category=Children">Children</a></li>
                <li><a href="?category=Jackets">Jackets</a></li>
        </ul></nav>
    </div></header>

    <!-- FIX #1: Carousel HTML elements - were completely missing -->
    <section class="carousel-section" id="carouselSection" style="display:none;">
        <div id="slideshowTrack" style="position:relative;"></div>
        <button class="ss-nav ss-prev" onclick="ssMove(-1)" aria-label="Previous slide">&#10094;</button>
        <button class="ss-nav ss-next" onclick="ssMove(1)" aria-label="Next slide">&#10095;</button>
        <div id="slideshowDots" class="ss-dots"></div>
    </section>

    <!-- SHOWCASE -->
    <section class="showcase-section" id="showcaseSection">
        <img src="images/showcase_hero.webp" alt="PAGUS Collection" class="showcase-hero-img">
        <div class="showcase-grid" id="showcaseGrid"></div>
    </section>
    
    <!-- HERO -->
    <section class="hero" id="heroSection">
        <div class="hero-content">
            <div class="hero-tagline">B2B Wholesale Menswear</div>
            <h2>Premium Suits &amp; Formal Wear</h2>
            <p>Direct from manufacturer in Ä°zmir, Turkey. We offer high-quality men&#x27;s suits, tuxedos, and formal wear for retailers and wholesalers worldwide. Minimum order: 50 pieces.</p>
            <div class="hero-stats">
                <div class="stat-item"><span class="stat-num">15+</span><span class="stat-label">Years Experience</span></div>
                <div class="stat-item"><span class="stat-num">50+</span><span class="stat-label">Countries</span></div>
                <div class="stat-item"><span class="stat-num">500+</span><span class="stat-label">Active Partners</span></div>
            </div>
        </div>
    </section>
    
    <section class="page-title-area" id="pageTitleArea" style="display:none;">
        <div id="back" class="back-btn" onclick="goBack()" style="display:none;">&#8592; BACK</div>
        <h1 class="cat-title" id="pTitle">COLLECTION</h1>
        <div class="info-guide" id="infoGuide"><span>&#128161;</span><b id="guideText">Tap heart to create list.</b></div>
    </section>
    <div class="grid" id="pGrid"><div style="grid-column:1/-1; text-align:center; padding:50px; color:#999;">Loading Collection...</div></div>
    <div id="searchResults" style="display:none;"></div>
    <section class="private-label" id="privateLabelSection"><div class="pl-content">
        <h2 class="pl-title">YOUR BRAND, OUR PRODUCTION</h2>
        <p style="color:#ddd; margin-bottom:35px;">Looking for a manufacturing partner? Pagus offers specialized Private Label services.</p>
        <a href="#" id="plWaLink" target="_blank" class="pl-btn">START PRODUCTION</a>
    </div></section>
    <button id="floatCart" class="float-cart" onclick="sendListToWhatsapp()">
        <svg style="width:20px;height:20px;fill:white;" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
        SEND <span id="cartCount">0</span>
    </button>
    <!-- FIX #11: Toast notification element -->
    <div id="toastNotification" class="toast-notification" role="alert" aria-live="polite"></div>

    <!-- AUTH MODAL -->
    <div class="auth-overlay" id="authOverlay" onclick="if(event.target===this)closeAuthModal()">
        <button class="auth-close" onclick="closeAuthModal()" aria-label="Close">&times;</button>
        <div class="auth-card">
            <div class="auth-header">
                <h3>PAGUS</h3>
                <p>B2B Wholesale Portal</p>
            </div>
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')" id="tabLogin">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('register')" id="tabRegister">Register</button>
            </div>
            <div class="auth-body">
                <div id="authError" class="auth-error"></div>
                <!-- LOGIN FORM -->
                <div id="loginForm">
                    <div class="auth-field">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com" autocomplete="email">
                    </div>
                    <div class="auth-field">
                        <label for="loginPass">Password</label>
                        <input type="password" id="loginPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" onkeypress="if(event.key==='Enter')doLogin()">
                    </div>
                    <button class="auth-submit" onclick="doLogin()" id="loginBtn">LOGIN</button>
                    <div class="auth-divider">or</div>
                    <button class="google-btn" onclick="doGoogleLogin()">
                        <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                        Continue with Google
                    </button>
                </div>
                <!-- REGISTER FORM -->
                <div id="registerForm" style="display:none;">
                    <div class="auth-field">
                        <label for="regName">Company / Name</label>
                        <input type="text" id="regName" placeholder="Your company or full name" autocomplete="name">
                    </div>
                    <div class="auth-field">
                        <label for="regEmail">Email</label>
                        <input type="email" id="regEmail" placeholder="your@email.com" autocomplete="email">
                    </div>
                    <div class="auth-field">
                        <label for="regPass">Password</label>
                        <input type="password" id="regPass" placeholder="Min. 6 characters" autocomplete="new-password">
                    </div>
                    <div class="auth-field">
                        <label for="regPass2">Confirm Password</label>
                        <input type="password" id="regPass2" placeholder="Repeat password" autocomplete="new-password" onkeypress="if(event.key==='Enter')doRegister()">
                    </div>
                    <button class="auth-submit" onclick="doRegister()" id="regBtn">CREATE ACCOUNT</button>
                    <div class="auth-divider">or</div>
                    <button class="google-btn" onclick="doGoogleLogin()">
                        <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                        Continue with Google
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- COOKIE BANNER -->
    <div class="cookie-banner" id="cookieBanner">
        <p>We use essential cookies and local storage to improve your experience. By continuing, you accept our <a href="privacy.html">Privacy Policy</a>.</p>
        <button class="cookie-accept" onclick="acceptCookies()">ACCEPT</button>
    </div>
    <div id="pModal" class="modal" role="dialog" aria-modal="true" aria-label="Product detail">
        <span class="close" onclick="closeModal()" role="button" aria-label="Close modal" tabindex="0">&#215;</span>
        <div class="modal-content">
            <div class="slider" id="sliderArea">
                <button class="arrow prev" onclick="move(-1)" aria-label="Previous image">&#10094;</button>
                <img id="mImg" class="main-img" src="" alt="Product Detail" onclick="openFullscreen(this.src)" style="cursor:zoom-in">
                <button class="arrow next" onclick="move(1)" aria-label="Next image">&#10095;</button>
                <div class="img-counter" id="imgCount">1/4</div>
            </div>
            <div class="side-info">
                <span style="color:var(--color-gold); font-weight:700; font-size:0.8rem; letter-spacing:2px;">WHOLESALE MANUFACTURER</span>
                <h2 id="mCode" style="font-family:var(--font-display); font-size:2.5rem; margin:15px 0 10px;">CODE</h2>
                <div id="modalPriceArea" style="margin-bottom:15px;"></div>
                <div class="badges"><div class="badge-item"><span class="badge-icon">ðŸ§µ</span>Premium Fabric</div><div class="badge-item"><span class="badge-icon">ðŸ‡¹ðŸ‡·</span>Made in Turkey</div><div class="badge-item"><span class="badge-icon">ðŸ“¦</span>Wholesale Only</div></div>
                <p style="color:#555; margin-bottom:40px; font-size:1rem;">Premium quality fabric available for bulk orders.</p>
                <a id="wp" href="#" target="_blank" style="background:var(--color-gold); color:#fff; padding:18px; text-align:center; font-weight:700; letter-spacing:1px; border-radius:4px; box-shadow: 0 10px 20px rgba(201,169,98,0.3); text-decoration:none;">ASK PRICE VIA WHATSAPP</a>
            </div>
        </div>
    </div>
    <!-- FIX #9: Fullscreen lightbox - separated background click layer from image -->
    <div id="fullscreenOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.97);z-index:99999;justify-content:center;align-items:center;">
        <div id="fullscreenBg" onclick="closeFullscreen()" style="position:absolute;inset:0;cursor:zoom-out;"></div>
        <button onclick="event.stopPropagation();moveFullscreen(-1)" aria-label="Previous image" style="position:absolute;left:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:2rem;width:50px;height:50px;border-radius:50%;cursor:pointer;z-index:2;">&#8249;</button>
        <img id="fullscreenImg" src="" alt="Product detail fullscreen" style="max-width:90vw;max-height:90vh;object-fit:contain;border-radius:4px;position:relative;z-index:1;">
        <button onclick="event.stopPropagation();moveFullscreen(1)" aria-label="Next image" style="position:absolute;right:20px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:2rem;width:50px;height:50px;border-radius:50%;cursor:pointer;z-index:2;">&#8250;</button>
        <button onclick="closeFullscreen()" aria-label="Close fullscreen" style="position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.1);border:none;color:#fff;font-size:2rem;width:50px;height:50px;border-radius:50%;cursor:pointer;z-index:2;">&times;</button>
        <div id="fullscreenCounter" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#888;font-size:0.9rem;z-index:2;">1/4</div>
    </div>
    <!-- FIX #14: Replaced document.write with span + JS textContent -->
    <footer class="footer"><div class="footer-grid">
        <div><h4>ABOUT PAGUS MENSWEAR</h4><p>PAGUS Menswear is established with a single mission: to provide world-class textile solutions.</p></div>
        <div><h4>B2B CONTACT</h4><ul><li><strong>WhatsApp:</strong> <span id="footerWa"></span></li><li><strong>Location:</strong> Izmir, Turkey</li><li><a href="payment.html" style="color:#999; text-decoration:none;">Secure Payment &amp; Bank Accounts</a></li></ul></div>
    </div><div style="text-align:center; margin-top:50px; font-size:0.8rem; color:#444;">&copy; <span id="footerYear"></span> Pagus Menswear. All Rights Reserved.</div></footer>
    <script src="inventory.js?v=1771500808"></script>
    <!-- Firebase SDK (Compat for single-file usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
    // ================================================================
    //  ðŸ”¥ FIREBASE CONFIG â€” Kendi project bilgilerini buraya yaz
    // ================================================================
    //  Firebase Console > Project Settings > General > Your Apps > Web App
    //  "firebaseConfig" objesini kopyalayÄ±p aÅŸaÄŸÄ±ya yapÄ±ÅŸtÄ±r.
    // ================================================================
    var firebaseConfig = {
        apiKey: "AIzaSyAWiTFG-XRg7u_dY7G_jftrL5uIwq4vvWM",
        authDomain: "pagus-website.firebaseapp.com",
        projectId: "pagus-website",
        storageBucket: "pagus-website.firebasestorage.app",
        messagingSenderId: "181201607827",
        appId: "1:181201607827:web:7872bded476390a6754166"
    };

    var _firebaseReady = false;
    var _currentUser = null;
    var _userRole = 'standard';
    var _priceCache = {};  // productId -> {standard, premium, vip, currency}

    try {
        firebase.initializeApp(firebaseConfig);
        _firebaseReady = true;
    } catch(e) {
        console.warn('Firebase init failed:', e.message);
    }

    var db = _firebaseReady ? firebase.firestore() : null;
    var auth = _firebaseReady ? firebase.auth() : null;

    // ===================== AUTH STATE =====================

    if(auth){
        auth.onAuthStateChanged(function(user){
            _currentUser = user;
            updateAuthUI();
            if(user){
                loadUserRole(user.uid);
                syncFavoritesFromFirestore(user.uid);
                loadAllPrices();
            } else {
                _userRole = 'standard';
                _priceCache = {};
                refreshPriceDisplays();
            }
        });
    }

    function updateAuthUI(){
        var area = document.getElementById('authArea');
        if(!area) return;
        if(_currentUser){
            var name = _currentUser.displayName || _currentUser.email.split('@')[0];
            area.innerHTML = '<div class="user-menu">'
                + '<span class="user-greeting">' + escapeHTML(name) + '</span>'
                + '<button class="logout-btn" onclick="doLogout()">Logout</button>'
                + '</div>';
        } else {
            area.innerHTML = '<button class="auth-btn" onclick="openAuthModal(\'login\')">LOGIN</button>';
        }
    }

    function loadUserRole(uid){
        if(!db) return;
        db.collection('users').doc(uid).get().then(function(doc){
            if(doc.exists){
                _userRole = doc.data().role || 'standard';
            }
            refreshPriceDisplays();
        }).catch(function(e){ console.warn('Role load error:', e); });
    }

    // ===================== AUTH MODAL =====================

    function openAuthModal(tab){
        document.getElementById('authOverlay').classList.add('visible');
        document.getElementById('authError').style.display = 'none';
        switchAuthTab(tab || 'login');
    }

    function closeAuthModal(){
        document.getElementById('authOverlay').classList.remove('visible');
        document.getElementById('authError').style.display = 'none';
    }

    function switchAuthTab(tab){
        document.getElementById('tabLogin').classList.toggle('active', tab === 'login');
        document.getElementById('tabRegister').classList.toggle('active', tab === 'register');
        document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
        document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
        document.getElementById('authError').style.display = 'none';
    }

    function showAuthError(msg){
        var el = document.getElementById('authError');
        el.textContent = msg;
        el.style.display = 'block';
    }

    function doLogin(){
        if(!auth){ showAuthError('Firebase not configured.'); return; }
        var email = document.getElementById('loginEmail').value.trim();
        var pass = document.getElementById('loginPass').value;
        if(!email || !pass){ showAuthError('Please fill in all fields.'); return; }

        var btn = document.getElementById('loginBtn');
        btn.disabled = true; btn.textContent = 'LOGGING IN...';

        auth.signInWithEmailAndPassword(email, pass)
            .then(function(){
                closeAuthModal();
                showToast('Welcome back!');
            })
            .catch(function(e){
                var msg = 'Login failed.';
                if(e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') msg = 'Invalid email or password.';
                if(e.code === 'auth/too-many-requests') msg = 'Too many attempts. Try again later.';
                showAuthError(msg);
            })
            .finally(function(){ btn.disabled = false; btn.textContent = 'LOGIN'; });
    }

    function doRegister(){
        if(!auth){ showAuthError('Firebase not configured.'); return; }
        var name = document.getElementById('regName').value.trim();
        var email = document.getElementById('regEmail').value.trim();
        var pass = document.getElementById('regPass').value;
        var pass2 = document.getElementById('regPass2').value;

        if(!name || !email || !pass){ showAuthError('Please fill in all fields.'); return; }
        if(pass.length < 6){ showAuthError('Password must be at least 6 characters.'); return; }
        if(pass !== pass2){ showAuthError('Passwords do not match.'); return; }

        var btn = document.getElementById('regBtn');
        btn.disabled = true; btn.textContent = 'CREATING...';

        auth.createUserWithEmailAndPassword(email, pass)
            .then(function(cred){
                // Set display name
                return cred.user.updateProfile({ displayName: name }).then(function(){
                    // Create Firestore user doc
                    if(db){
                        return db.collection('users').doc(cred.user.uid).set({
                            displayName: name,
                            email: email,
                            role: 'standard',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                });
            })
            .then(function(){
                closeAuthModal();
                updateAuthUI();
                showToast('Account created! Welcome, ' + name);
            })
            .catch(function(e){
                var msg = 'Registration failed.';
                if(e.code === 'auth/email-already-in-use') msg = 'Email already registered. Try logging in.';
                if(e.code === 'auth/weak-password') msg = 'Password is too weak.';
                if(e.code === 'auth/invalid-email') msg = 'Invalid email address.';
                showAuthError(msg);
            })
            .finally(function(){ btn.disabled = false; btn.textContent = 'CREATE ACCOUNT'; });
    }

    function doLogout(){
        if(!auth) return;
        auth.signOut().then(function(){
            showToast('Logged out.');
            updateAuthUI();
            refreshPriceDisplays();
        });
    }

    function doGoogleLogin(){
        if(!auth){ showAuthError('Firebase not configured.'); return; }
        var provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then(function(result){
                var user = result.user;
                var isNew = result.additionalUserInfo && result.additionalUserInfo.isNewUser;
                if(isNew && db){
                    db.collection('users').doc(user.uid).set({
                        displayName: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        role: 'standard',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                closeAuthModal();
                showToast('Welcome, ' + (user.displayName || 'there') + '!');
            })
            .catch(function(e){
                if(e.code === 'auth/popup-closed-by-user') return;
                if(e.code === 'auth/popup-blocked'){
                    showAuthError('Popup blocked. Please allow popups for this site.');
                    return;
                }
                showAuthError('Google login failed: ' + e.message);
            });
    }

    // ===================== PRICING =====================

    function loadAllPrices(){
        if(!db || !_currentUser) return;
        db.collection('pricing').get().then(function(snap){
            _priceCache = {};
            snap.forEach(function(doc){
                _priceCache[doc.id] = doc.data();
            });
            refreshPriceDisplays();
        }).catch(function(e){ console.warn('Price load error:', e); });
    }

    function getPrice(productId){
        var p = _priceCache[productId];
        if(!p) return null;
        var val = p[_userRole] || p['standard'] || null;
        if(val === null || val === undefined) return null;
        var currency = p.currency || 'EUR';
        return { value: val, currency: currency };
    }

    function formatPrice(price){
        if(!price) return '';
        return 'â‚¬' + Number(price.value).toFixed(2);
    }

    function refreshPriceDisplays(){
        // Update price tags on product cards
        document.querySelectorAll('[data-price-id]').forEach(function(el){
            var pid = el.dataset.priceId;
            if(_currentUser){
                var price = getPrice(pid);
                if(price){
                    el.innerHTML = '<span class="price-tag">' + formatPrice(price) + '</span>'
                        + '<span class="price-tier">' + escapeHTML(_userRole) + ' price</span>';
                } else {
                    el.innerHTML = '<span class="price-tag" style="font-size:0.85rem;color:#999;">Price on request</span>';
                }
            } else {
                el.innerHTML = '<span class="price-login-hint" onclick="event.stopPropagation();openAuthModal(\'login\')">Login to see prices</span>';
            }
        });

        // Update modal price if open
        var modalPrice = document.getElementById('modalPriceArea');
        if(modalPrice && activeCode){
            if(_currentUser){
                var mp = getPrice(activeCode);
                if(mp){
                    modalPrice.innerHTML = '<div class="modal-price">' + formatPrice(mp) + '</div>'
                        + '<span class="price-tier">' + escapeHTML(_userRole) + ' price</span>';
                } else {
                    modalPrice.innerHTML = '<div class="modal-price" style="font-size:1.2rem;color:#999;">Price on request</div>';
                }
            } else {
                modalPrice.innerHTML = '<span class="modal-price-hint" onclick="openAuthModal(\'login\')">Login to see wholesale prices â†’</span>';
            }
        }
    }

    // ===================== FAVORITES SYNC =====================

    function syncFavoritesFromFirestore(uid){
        if(!db) return;
        db.collection('users').doc(uid).collection('favorites').get().then(function(snap){
            var firestoreFavs = [];
            snap.forEach(function(doc){ firestoreFavs.push(doc.id); });

            // Merge: localStorage + Firestore (union)
            var merged = [...new Set([...cart, ...firestoreFavs])];
            cart = merged;
            if(lsAvailable) localStorage.setItem('pagusCart', JSON.stringify(cart));
            updateCartUI();

            // Save merged back to Firestore
            var batch = db.batch();
            merged.forEach(function(code){
                batch.set(db.collection('users').doc(uid).collection('favorites').doc(code), {
                    addedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
            batch.commit().catch(function(e){ console.warn('Fav sync error:', e); });
        }).catch(function(e){ console.warn('Fav load error:', e); });
    }

    function saveFavToFirestore(code, add){
        if(!db || !_currentUser) return;
        var ref = db.collection('users').doc(_currentUser.uid).collection('favorites').doc(code);
        if(add){
            ref.set({ addedAt: firebase.firestore.FieldValue.serverTimestamp() }).catch(function(){});
        } else {
            ref.delete().catch(function(){});
        }
    }

    // ===================== COOKIE BANNER =====================

    function initCookieBanner(){
        try {
            if(!localStorage.getItem('pagus_cookie_consent')){
                document.getElementById('cookieBanner').classList.add('visible');
            }
        } catch(e){
            // No localStorage â€” don't show banner
        }
    }

    function acceptCookies(){
        try { localStorage.setItem('pagus_cookie_consent', '1'); } catch(e){}
        document.getElementById('cookieBanner').classList.remove('visible');
    }

    initCookieBanner();
    </script>
    <script>
        // ============================================================
        // PAGUS MENSWEAR - FIXED VERSION
        // All 14 issues resolved (see FIX comments throughout)
        // ============================================================

        var FEATURES={carousel:false,hero:true,search:true,favorites:true,whatsappFloat:true,privateLabel:true,showcase:true};
        var WHATSAPP_NUMBER='905511748907';
        var CAT_DISPLAY_NAMES={"Ã‡Ä±kma Yaka":"Detachable Collar"};

        // i18n helper â€” single source of truth for language detection & texts
        var LANG=(navigator.language||navigator.userLanguage||'').startsWith('it')?'it':'en';
        var TEXTS={
            guide_tap:       {it:"Tocca l'icona del cuore per creare la tua lista.", en:"Tap heart to create list."},
            search_min:      {it:'Inserisci almeno 2 caratteri',                     en:'Please enter at least 2 characters'},
            wa_list_header:  {it:'Salve Pagus, sono interessato ai prezzi di questi modelli:',  en:'Hi Pagus, I am interested in the prices for these models:'},
            wa_list_footer:  {it:'Grazie.',                                          en:'Thanks.'},
            wa_inquiry:      {it:'Salve, vorrei ricevere informazioni sul modello: ', en:'Hi, inquiring about: '},
            popup_blocked:   {it:'Popup bloccato. Consenti i popup per WhatsApp.',   en:'Popup blocked. Please allow popups for WhatsApp.'}
        };
        function t(key){return(TEXTS[key]&&TEXTS[key][LANG])||((TEXTS[key]&&TEXTS[key]['en'])||key);}
        var urlParams=new URLSearchParams(window.location.search);
        var curCat=urlParams.get('category')||"Wedding Suits";
        var curSub=urlParams.get('subcategory');

        var cart=[];
        var lsAvailable=true;
        try{localStorage.setItem('_test','1');localStorage.removeItem('_test');cart=JSON.parse(localStorage.getItem('pagusCart'))||[];}catch(e){lsAvailable=false;cart=[];}

        // FIX #14: Footer year without document.write
        document.getElementById('footerYear').textContent=new Date().getFullYear();

        // ===================== UTILITY FUNCTIONS =====================

        function escapeHTML(s){
            if(!s)return '';
            return String(s).replace(/[&<>'"]/g,function(t){
                return{'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[t];
            });
        }

        // FIX #6: Removed dead escapeJS function (was defined but never called)

        function escapeAttr(s){
            if(!s)return '';
            return String(s).replace(/[&<>"'`=\/]/g,function(t){
                return'&#'+t.charCodeAt(0)+';';
            });
        }

        // FIX #5: Strict focal-y sanitizer â€” only allows integer 0-100, prevents XSS via inline style
        function safeFocalY(val){
            var n=parseInt(val,10);
            if(isNaN(n)||n<0||n>100) return 20;
            return n;
        }

        // FIX #11: Styled toast notification instead of native alert()
        function showToast(msg,duration){
            duration=duration||3000;
            var t=document.getElementById('toastNotification');
            t.textContent=msg;
            t.classList.add('visible');
            clearTimeout(window._toastTimer);
            window._toastTimer=setTimeout(function(){t.classList.remove('visible');},duration);
        }

        function setLanguage(){
            var g=document.getElementById('guideText');
            g.innerText=t('guide_tap');
        }

        // ===================== PRODUCT DATA INIT =====================

        if(typeof productsDB==='undefined'){
            document.getElementById('pGrid').innerHTML="<div style='text-align:center;width:100%;padding:50px;color:red;'>Error: inventory.js not found.</div>";
        }else{
            productsDB.forEach(function(p){
                if(p.category&&p.category.includes(' > ')){
                    var a=p.category.split(' > ');
                    p.mainCat=a[0].trim();
                    p.subCat=a[1].trim();
                }else{
                    p.mainCat=p.category;
                    p.subCat="General";
                }
                p.code=p.id;
                p.realCode=p.id;
                p.folderPath=p.path;
                p.focalY=p.focal_y||20;
            });
            setLanguage();
            init();
            updateCartUI();
        }

        // ===================== SHOWCASE =====================
        // FIX #13: tabindex + keyboard Enter/Space for accessibility

        function renderShowcase(){
            var grid=document.getElementById('showcaseGrid');
            if(!grid)return;
            if(typeof productsDB==='undefined'||!productsDB||productsDB.length===0){grid.innerHTML='';return;}

            var catProducts={};
            for(var i=0;i<productsDB.length;i++){
                var p=productsDB[i];
                var mainCat=p.category.indexOf(' > ')>-1?p.category.split(' > ')[0]:p.category;
                if(!catProducts[mainCat])catProducts[mainCat]=[];
                catProducts[mainCat].push(p);
            }

            var items=[];
            var cats=Object.keys(catProducts);
            for(var c=0;c<cats.length&&items.length<4;c++){
                var catName=cats[c];
                var prods=catProducts[catName];
                for(var j=0;j<prods.length&&items.length<4;j++){
                    if(items.length<4){items.push({cat:catName,path:prods[j].path});}
                    if(cats.length<4&&items.length<4&&j<prods.length-1){items.push({cat:catName,path:prods[j+1].path});break;}
                }
            }

            var html='';
            for(var k=0;k<items.length;k++){
                var it=items[k];
                // FIX #13: Added tabindex="0", role="link", and onkeydown for keyboard nav
                html+='<div class="showcase-item" tabindex="0" role="link" data-cat="'+escapeAttr(it.cat)+'"'
                    +' onclick="window.location.href=\'?category=\'+encodeURIComponent(this.dataset.cat)"'
                    +' onkeydown="if(event.key===\'Enter\'||event.key===\' \'){event.preventDefault();window.location.href=\'?category=\'+encodeURIComponent(this.dataset.cat);}">';
                html+='<img src="'+escapeAttr(it.path)+'/1.webp" alt="'+escapeAttr(it.cat)+'" onerror="this.parentElement.style.display=\'none\'">';
                html+='<div class="showcase-overlay"><span>'+escapeHTML(CAT_DISPLAY_NAMES[it.cat]||it.cat).toUpperCase()+'</span></div></div>';
            }
            grid.innerHTML=html;
        }

        // ===================== MAIN INIT =====================
        // FIX #2: Null-safe element access throughout

        function init(){
            var waUrl='https://wa.me/'+WHATSAPP_NUMBER;
            var wl=document.getElementById('waLink');
            if(wl)wl.href=waUrl;
            var pl=document.getElementById('plWaLink');
            if(pl)pl.href=waUrl;
            var fw=document.getElementById('footerWa');
            if(fw)fw.textContent='+'+WHATSAPP_NUMBER;

            var hero=document.getElementById('heroSection');
            var showcase=document.getElementById('showcaseSection');
            var carousel=document.getElementById('carouselSection');
            var pta=document.getElementById('pageTitleArea');
            var sr=document.getElementById('searchResults');
            var floatCartBtn=document.getElementById('floatCart');
            var privLabel=document.getElementById('privateLabelSection');
            var searchBox=document.querySelector('.search-box');

            // FIX #2: Every element access guarded with null check
            if(!FEATURES.hero&&hero)hero.style.display='none';
            if(!FEATURES.showcase&&showcase)showcase.style.display='none';
            if(!FEATURES.carousel&&carousel)carousel.style.display='none';
            if(!FEATURES.whatsappFloat&&floatCartBtn)floatCartBtn.style.display='none';
            if(!FEATURES.privateLabel&&privLabel)privLabel.style.display='none';
            if(!FEATURES.search&&searchBox)searchBox.style.display='none';
            if(!FEATURES.favorites){
                document.querySelectorAll('.heart-btn').forEach(function(b){b.style.display='none';});
                document.querySelectorAll('.fab').forEach(function(b){b.style.display='none';});
            }

            if(urlParams.get('search')){
                if(hero)hero.style.display='none';
                if(showcase)showcase.style.display='none';
                if(carousel)carousel.style.display='none';
                if(pta)pta.style.display='none';
                if(sr)sr.style.display='block';
                document.getElementById('pGrid').style.display='none';
                doSearchDisplay(urlParams.get('search'));
            }else if(urlParams.get('category')||urlParams.get('subcategory')){
                if(hero)hero.style.display='none';
                if(showcase)showcase.style.display='none';
                if(carousel)carousel.style.display='none';
                if(sr)sr.style.display='none';
                if(pta)pta.style.display='block';
                if(curSub) showProducts(); else showSubs();
            }else{
                if(FEATURES.hero&&hero)hero.style.display='block';
                if(FEATURES.showcase&&showcase){showcase.style.display='block';renderShowcase();}
                // FIX #1: Carousel init with proper HTML
                if(FEATURES.carousel&&carousel){carousel.style.display='block';startCarousel();}
                if(pta)pta.style.display='none';
                if(sr)sr.style.display='none';
                document.getElementById('pGrid').style.display='none';
            }
        }

        // ===================== SEARCH =====================
        // FIX #11: Toast instead of alert, with i18n
        // FIX #5: safeFocalY in search results

        function doSiteSearch(){
            var q=document.getElementById('siteSearch').value.trim();
            if(q.length<2){
                showToast(t('search_min'));
                return;
            }
            window.location.href='?search='+encodeURIComponent(q);
        }

        function openSearchResult(resultIdx){
            if(!window._searchResults||!window._searchResults[resultIdx])return;
            var r=window._searchResults[resultIdx];
            openModal(r.id,r.id,r.path);
        }

        function doSearchDisplay(q){
            var results=[];
            var qLower=q.toLowerCase();
            for(var i=0;i<productsDB.length;i++){
                var p=productsDB[i];
                if(p.id.toLowerCase().indexOf(qLower)>-1||p.category.toLowerCase().indexOf(qLower)>-1){
                    results.push(p);
                }
            }

            var container=document.getElementById('searchResults');
            var safeQ=escapeHTML(q);
            var html='<div class="search-results-section"><h2 class="search-results-title">'+results.length+' results for "'+safeQ+'"</h2>';

            if(results.length===0){
                html+='<p style="text-align:center;color:#999;padding:50px;">No results found</p>';
            }else{
                html+='<div class="search-results-grid">';
                for(var j=0;j<results.length;j++){
                    var r=results[j];
                    var sub=r.category.indexOf(' > ')>-1?r.category.split(' > ')[1]:r.category;
                    // FIX #5: safeFocalY instead of raw parseInt
                    var fy=safeFocalY(r.focalY||r.focal_y);
                    html+='<div class="search-result-card" data-idx="'+j+'" onclick="openSearchResult('+j+')">';
                    html+='<img src="'+escapeAttr(r.path)+'/1.webp" style="object-position:center '+fy+'%;" alt="'+escapeAttr(r.id)+'">';
                    html+='<div class="info"><h4>'+escapeHTML(r.id)+'</h4><span>'+escapeHTML(sub)+'</span>'
                        +'<div data-price-id="'+escapeAttr(r.id)+'" style="margin-top:5px;"></div></div></div>';
                }
                html+='</div>';
            }
            html+='</div>';
            container.innerHTML=html;
            window._searchResults=results;
            if(typeof refreshPriceDisplays==='function') refreshPriceDisplays();
        }

        // ===================== SUBCATEGORY & PRODUCT VIEWS =====================
        // FIX #5: safeFocalY everywhere
        // FIX #12: Formatted for readability (was single-line minified)
        // FIX #13: aria-labels on heart buttons

        function showSubs(){
            document.getElementById('pGrid').style.display='grid';
            var cd=productsDB.find(function(p){return p.mainCat.toLowerCase()===curCat.toLowerCase();});
            var dc=cd?cd.mainCat:curCat;
            document.getElementById('pTitle').textContent=CAT_DISPLAY_NAMES[dc]||dc;
            document.getElementById('back').style.display="none";
            document.getElementById('infoGuide').style.display="none";

            var ss=[...new Set(productsDB.filter(function(p){
                return p.mainCat.toLowerCase()===curCat.toLowerCase();
            }).map(function(p){return p.subCat;}))];

            if(ss.length===0){
                document.getElementById('pGrid').innerHTML='<div style="grid-column:1/-1;text-align:center;color:#999;padding:50px;">Collection is being updated...</div>';
                return;
            }

            document.getElementById('pGrid').innerHTML=ss.map(function(s){
                var cv=productsDB.find(function(p){return p.subCat===s;});
                var ss2=escapeHTML(s);
                var ip=escapeAttr(cv.folderPath)+'/1.webp';
                var fy=safeFocalY(cv.focalY);
                return '<div class="card" data-cat="'+escapeAttr(curCat)+'" data-sub="'+escapeAttr(s)+'"'
                    +' onclick="window.location.href=\'?category=\'+encodeURIComponent(this.dataset.cat)+\'&subcategory=\'+encodeURIComponent(this.dataset.sub)">'
                    +'<div class="img-box"><img src="'+ip+'" style="object-position:center '+fy+'%;" loading="lazy" onerror="this.parentElement.style.background=\'#ddd\';" alt="'+escapeAttr(s)+'"></div>'
                    +'<div class="info-box"><h3 class="info-title">'+ss2+'</h3>'
                    +'<span style="color:var(--color-gold);font-size:0.7rem;font-weight:700;">VIEW COLLECTION</span></div></div>';
            }).join('');
        }

        function showProducts(){
            document.getElementById('pGrid').style.display='grid';
            document.getElementById('pTitle').textContent=curSub;
            document.getElementById('back').style.display="inline-block";
            document.getElementById('infoGuide').style.display="flex";

            var ps=productsDB.filter(function(p){
                return p.mainCat.toLowerCase()===curCat.toLowerCase()&&p.subCat===curSub;
            });

            if(ps.length===0){
                document.getElementById('pGrid').innerHTML='<div style="text-align:center;width:100%;">No products found.</div>';
                return;
            }

            window._currentProducts=ps;

            document.getElementById('pGrid').innerHTML=ps.map(function(p,i){
                var ip=escapeAttr(p.folderPath)+'/1.webp';
                var fy=safeFocalY(p.focalY);
                var f=cart.includes(p.realCode)?'active':'';
                var h=f?'\u2665':'\u2661';
                // FIX #13: aria-label on heart buttons
                var ariaLabel=f?'Remove '+escapeAttr(p.realCode)+' from list':'Add '+escapeAttr(p.realCode)+' to list';
                return '<div class="card" data-pidx="'+i+'" onclick="openProductByIdx('+i+')">'
                    +'<button class="heart-btn '+f+'" data-code="'+escapeAttr(p.realCode)+'" onclick="toggleCartSafe(event,this)" aria-label="'+ariaLabel+'">'+h+'</button>'
                    +'<div class="img-box"><img src="'+ip+'" style="object-position:center '+fy+'%;" loading="lazy" onerror="this.parentElement.style.background=\'#ddd\';" alt="'+escapeAttr(p.realCode)+'"></div>'
                    +'<h3 class="info-title">'+escapeHTML(p.realCode)+'</h3>'
                    +'<div data-price-id="'+escapeAttr(p.realCode)+'"></div></div>';
            }).join('');
            if(typeof refreshPriceDisplays==='function') refreshPriceDisplays();
        }

        function openProductByIdx(i){
            if(!window._currentProducts||!window._currentProducts[i])return;
            var p=window._currentProducts[i];
            openModal(p.code,p.realCode,p.folderPath);
        }

        // FIX #13: Update aria-label when toggling
        function toggleCartSafe(e,btn){
            e.stopPropagation();
            var c=btn.dataset.code;
            if(cart.includes(c)){
                cart=cart.filter(function(i){return i!==c;});
                btn.innerText='\u2661';
                btn.classList.remove('active');
                btn.setAttribute('aria-label','Add '+c+' to list');
            }else{
                cart.push(c);
                btn.innerText='\u2665';
                btn.classList.add('active');
                btn.setAttribute('aria-label','Remove '+c+' from list');
            }
            if(lsAvailable)localStorage.setItem('pagusCart',JSON.stringify(cart));
            if(typeof saveFavToFirestore==='function') saveFavToFirestore(c, cart.includes(c));
            updateCartUI();
        }

        function goBack(){window.location.href='?category='+encodeURIComponent(curCat);}

        function updateCartUI(){
            var b=document.getElementById('floatCart');
            var c=document.getElementById('cartCount');
            c.innerText=cart.length;
            b.style.display=cart.length>0?"flex":"none";
        }

        // ===================== WHATSAPP CART =====================
        // FIX #7: Only clear cart after confirmed WhatsApp window opened
        // Uses visibilitychange instead of blind setTimeout

        function sendListToWhatsapp(){
            if(cart.length===0)return;
            var c=cart.join(", ");
            var m=t('wa_list_header')+"\n\n"+c+"\n\n"+t('wa_list_footer');

            var waWindow=window.open('https://wa.me/'+WHATSAPP_NUMBER+'?text='+encodeURIComponent(m),'_blank');

            if(waWindow){
                // FIX #7: Clear cart when user returns from WhatsApp tab
                var clearOnReturn=function(){
                    if(document.visibilityState==='visible'){
                        document.removeEventListener('visibilitychange',clearOnReturn);
                        cart=[];
                        if(lsAvailable)localStorage.removeItem('pagusCart');
                        updateCartUI();
                        document.querySelectorAll('.heart-btn').forEach(function(b){
                            b.innerText='\u2661';
                            b.classList.remove('active');
                            b.setAttribute('aria-label','Add '+b.dataset.code+' to list');
                        });
                    }
                };
                document.addEventListener('visibilitychange',clearOnReturn);
            }else{
                // FIX #7: Popup was blocked â€” notify user, don't clear cart
                showToast(t('popup_blocked'));
            }
        }

        // ===================== MODAL =====================
        // FIX #3: popstate race condition â€” proper state tracking
        // FIX #4: probeImageCount race condition â€” session tracking
        // FIX #13: Focus trap for accessibility

        var activeCode="",activePath="";
        var idx=1,maxIdx=1;
        var _probeSession=0;  // FIX #4: Track probe sessions
        var _modalOpen=false;  // FIX #3: Track modal state

        // FIX #4: Probe with session tracking to prevent stale callbacks
        function probeImageCount(basePath,cb){
            _probeSession++;
            var session=_probeSession;
            var count=1;
            function check(n){
                if(n>20){cb(count);return;}
                if(session!==_probeSession)return; // FIX #4: Abort stale probe
                var img=new Image();
                img.onload=function(){
                    if(session!==_probeSession)return;
                    count=n;
                    check(n+1);
                };
                img.onerror=function(){
                    if(session!==_probeSession)return;
                    cb(count);
                };
                img.src=basePath+'/'+n+'.webp';
            }
            check(2);
        }

        function openModal(c,r,f){
            activeCode=c;
            activePath=f;
            idx=1;

            // FIX #15: Use imageCount from inventory.js if available, probe as fallback
            var knownCount=0;
            if(typeof productsDB!=='undefined'){
                for(var i=0;i<productsDB.length;i++){
                    if(productsDB[i].path===f&&productsDB[i].imageCount){
                        knownCount=productsDB[i].imageCount;
                        break;
                    }
                }
            }

            if(knownCount>0){
                maxIdx=knownCount;
                document.getElementById('imgCount').textContent='1/'+maxIdx;
            }else{
                maxIdx=1;
                document.getElementById('imgCount').textContent='1/...';
                // Fallback: probe if imageCount not in inventory.js
                probeImageCount(f,function(n){
                    maxIdx=n;
                    if(idx>maxIdx) idx=maxIdx;
                    document.getElementById('imgCount').textContent=idx+'/'+maxIdx;
                });
            }

            // FIX #3: Only push state if modal isn't already open
            if(!_modalOpen){
                history.pushState({modal:true},null,"");
            }
            _modalOpen=true;

            var m=document.getElementById('pModal');
            m.style.display="block";
            document.getElementById('mCode').textContent=r;

            var msg=t('wa_inquiry')+r;
            document.getElementById('wp').href='https://wa.me/'+WHATSAPP_NUMBER+'?text='+encodeURIComponent(msg);

            update();

            // FIX #13: Setup focus trap
            m.setAttribute('tabindex','-1');
            m.focus();
            setupFocusTrap(m);
            if(typeof refreshPriceDisplays==='function') refreshPriceDisplays();
        }

        // FIX #3: Clean closeModal with proper state reset
        function closeModal(){
            var m=document.getElementById('pModal');
            if(m.style.display==="none")return;
            m.style.display="none";
            _probeSession++; // FIX #4: Invalidate running probe

            if(_modalOpen){
                _modalOpen=false;
                if(history.state&&history.state.modal){
                    history.back();
                }
            }
            removeFocusTrap(); // FIX #13
        }

        // FIX #13: Focus trap for modal accessibility
        var _focusTrapHandler=null;
        function setupFocusTrap(modal){
            removeFocusTrap();
            _focusTrapHandler=function(e){
                if(e.key!=='Tab')return;
                var focusable=modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if(focusable.length===0)return;
                var first=focusable[0];
                var last=focusable[focusable.length-1];
                if(e.shiftKey){
                    if(document.activeElement===first){e.preventDefault();last.focus();}
                }else{
                    if(document.activeElement===last){e.preventDefault();first.focus();}
                }
            };
            document.addEventListener('keydown',_focusTrapHandler);
        }
        function removeFocusTrap(){
            if(_focusTrapHandler){
                document.removeEventListener('keydown',_focusTrapHandler);
                _focusTrapHandler=null;
            }
        }

        // ===================== FULLSCREEN =====================
        // FIX #9: Clean event propagation â€” background layer handles close

        var fsIdx=1;

        function openFullscreen(src){
            var o=document.getElementById('fullscreenOverlay');
            document.getElementById('fullscreenImg').src=src;
            fsIdx=idx;
            updateFsCounter();
            o.style.display='flex';
        }

        function closeFullscreen(){
            document.getElementById('fullscreenOverlay').style.display='none';
        }

        function moveFullscreen(d){
            fsIdx+=d;
            if(fsIdx<1)fsIdx=maxIdx;
            if(fsIdx>maxIdx)fsIdx=1;
            var img=document.getElementById('fullscreenImg');
            img.src=activePath+'/'+fsIdx+'.webp';
            img.onerror=function(){fsIdx=1;img.src=activePath+'/1.webp';updateFsCounter();};
            updateFsCounter();
        }

        function updateFsCounter(){
            document.getElementById('fullscreenCounter').textContent=fsIdx+'/'+maxIdx;
        }

        // ===================== KEYBOARD EVENTS =====================

        document.addEventListener('keydown',function(e){
            if(e.key==='Tab')return; // Let focus trap handle Tab
            var o=document.getElementById('fullscreenOverlay');
            if(o.style.display==='flex'){
                if(e.key==='Escape')closeFullscreen();
                if(e.key==='ArrowLeft')moveFullscreen(-1);
                if(e.key==='ArrowRight')moveFullscreen(1);
                return;
            }
            if(document.getElementById('pModal').style.display==="block"){
                if(e.key==="Escape")closeModal();
                if(e.key==="ArrowLeft")move(-1);
                if(e.key==="ArrowRight")move(1);
            }
        });

        // ===================== TOUCH EVENTS =====================

        var touchStartX=0;
        document.getElementById('fullscreenOverlay').addEventListener('touchstart',function(e){
            touchStartX=e.changedTouches[0].screenX;
        },{passive:true});
        document.getElementById('fullscreenOverlay').addEventListener('touchend',function(e){
            var diff=e.changedTouches[0].screenX-touchStartX;
            if(Math.abs(diff)>50){
                if(diff>0)moveFullscreen(-1);else moveFullscreen(1);
            }
        },{passive:true});

        window.addEventListener('click',function(e){
            if(e.target==document.getElementById('pModal'))closeModal();
        });

        // FIX #3: Proper popstate handler â€” full state cleanup
        window.onpopstate=function(){
            if(_modalOpen){
                var m=document.getElementById('pModal');
                m.style.display="none";
                _modalOpen=false;
                _probeSession++; // FIX #4: Invalidate probe
                removeFocusTrap(); // FIX #13
            }
        };

        var tsx=0,tex=0;
        var sl=document.getElementById('sliderArea');
        sl.addEventListener('touchstart',function(e){tsx=e.changedTouches[0].screenX;},{passive:true});
        sl.addEventListener('touchend',function(e){tex=e.changedTouches[0].screenX;hs();},{passive:true});

        function hs(){if(tex<tsx-50)move(1);if(tex>tsx+50)move(-1);}

        // FIX #4: move() clamps to maxIdx safely
        function move(d){
            idx+=d;
            if(idx<1)idx=maxIdx;
            if(idx>maxIdx)idx=1;
            document.getElementById('imgCount').textContent=idx+'/'+maxIdx;
            update();
        }

        function update(){
            var img=document.getElementById('mImg');
            img.style.opacity=0;
            img.src=activePath+'/'+idx+'.webp';
            img.onload=function(){img.style.opacity=1;};
            img.onerror=function(){
                if(idx>1){idx=1;update();}
                else{img.style.opacity=1;img.parentElement.style.background='#333';}
            };
        }

        // ===================== CAROUSEL =====================
        // FIX #1: Now has matching HTML elements with null-safety

        function startCarousel(){
            var track=document.getElementById('slideshowTrack');
            var counter=document.getElementById('slideshowDots');
            // FIX #1: Null check â€” exit gracefully if elements missing
            if(!track||!counter)return;
            if(!productsDB||productsDB.length===0)return;

            var slides=[];
            for(var i=0;i<productsDB.length;i++){
                var p=productsDB[i];
                var sub=p.category.indexOf(' > ')>-1?p.category.split(' > ')[1]:p.category;
                var cat=p.category.indexOf(' > ')>-1?p.category.split(' > ')[0]:p.category;
                slides.push({img:p.path+'/1.webp',title:p.id,sub:sub,cat:cat,path:p.path});
            }

            // Shuffle
            for(var j=slides.length-1;j>0;j--){
                var k=Math.floor(Math.random()*(j+1));
                var t=slides[j];slides[j]=slides[k];slides[k]=t;
            }

            window._carouselSlides=slides;
            var html='';
            for(var m=0;m<slides.length;m++){
                var s=slides[m];
                var cls=m===0?'ss-slide active':'ss-slide';
                html+='<div class="'+cls+'" data-slidx="'+m+'" onclick="openFromCarouselSafe('+m+')">';
                html+='<img src="'+escapeAttr(s.img)+'" alt="'+escapeAttr(s.title)+'" onerror="this.parentElement.classList.add(\'ss-broken\')">';
                html+='<div class="ss-slide-info"><h4>'+escapeHTML(s.title)+'</h4><span>'+escapeHTML(s.sub)+'</span></div></div>';
            }
            track.innerHTML=html;

            var validSlides=document.querySelectorAll('.ss-slide:not(.ss-broken)');
            counter.innerHTML='<span class="ss-counter">1 / '+validSlides.length+'</span>';
            window.CAROUSEL_INDEX=0;
            window.CAROUSEL_TOTAL=document.querySelectorAll('.ss-slide').length;

            if(window.CAROUSEL_TIMER)clearInterval(window.CAROUSEL_TIMER);
            window.CAROUSEL_TIMER=setInterval(carouselNext,5000);
        }

        function openFromCarouselSafe(carIdx){
            if(!window._carouselSlides||!window._carouselSlides[carIdx])return;
            var s=window._carouselSlides[carIdx];
            openModal(s.title,s.title,s.path);
        }

        function carouselNext(){
            var all=document.querySelectorAll('.ss-slide');
            if(!all||all.length===0)return;
            var attempts=0;
            do{
                window.CAROUSEL_INDEX++;
                if(window.CAROUSEL_INDEX>=window.CAROUSEL_TOTAL)window.CAROUSEL_INDEX=0;
                attempts++;
            }while(all[window.CAROUSEL_INDEX]&&all[window.CAROUSEL_INDEX].classList.contains('ss-broken')&&attempts<window.CAROUSEL_TOTAL);
            carouselShow();
        }

        function carouselShow(){
            var all=document.querySelectorAll('.ss-slide');
            if(!all||all.length===0)return;
            for(var i=0;i<all.length;i++){
                all[i].className=all[i].classList.contains('ss-broken')?'ss-slide ss-broken':'ss-slide';
            }
            if(all[window.CAROUSEL_INDEX]){
                all[window.CAROUSEL_INDEX].className=all[window.CAROUSEL_INDEX].classList.contains('ss-broken')?'ss-slide ss-broken':'ss-slide active';
            }
            var valid=document.querySelectorAll('.ss-slide:not(.ss-broken)').length;
            var current=0;
            for(var j=0;j<=window.CAROUSEL_INDEX;j++){
                if(all[j]&&!all[j].classList.contains('ss-broken'))current++;
            }
            var c=document.querySelector('.ss-counter');
            if(c)c.innerText=current+' / '+valid;
        }

        function ssMove(dir){
            var all=document.querySelectorAll('.ss-slide');
            if(!all||all.length===0)return;
            var attempts=0;
            do{
                window.CAROUSEL_INDEX+=dir;
                if(window.CAROUSEL_INDEX>=window.CAROUSEL_TOTAL)window.CAROUSEL_INDEX=0;
                if(window.CAROUSEL_INDEX<0)window.CAROUSEL_INDEX=window.CAROUSEL_TOTAL-1;
                attempts++;
            }while(all[window.CAROUSEL_INDEX]&&all[window.CAROUSEL_INDEX].classList.contains('ss-broken')&&attempts<window.CAROUSEL_TOTAL);
            carouselShow();
        }
    </script>
</body>
</html>
