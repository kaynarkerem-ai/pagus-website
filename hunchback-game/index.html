<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Hunchback - HTML5 Clone</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0a0a1a;display:flex;justify-content:center;align-items:center;min-height:100vh;overflow:hidden;font-family:'Press Start 2P',monospace}
#gameWrapper{position:relative;width:640px;max-width:100vw}
canvas{display:block;width:100%;height:auto;image-rendering:pixelated;image-rendering:crisp-edges}
#mobileControls{display:none;position:absolute;bottom:8px;left:0;right:0;padding:0 10px;justify-content:space-between;pointer-events:none}
@media(pointer:coarse){#mobileControls{display:flex!important}}
.mBtn{pointer-events:auto;width:56px;height:56px;border-radius:12px;background:rgba(255,255,255,.15);border:2px solid rgba(255,255,255,.3);color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;user-select:none;-webkit-user-select:none;touch-action:manipulation;backdrop-filter:blur(4px)}
.mBtn:active{background:rgba(255,255,255,.35)}
.btnGroup{display:flex;gap:8px}
</style>
</head>
<body>
<div id="gameWrapper">
<canvas id="c" width="640" height="400"></canvas>
<div id="mobileControls">
<div class="btnGroup">
<button class="mBtn" id="btnL">◀</button>
<button class="mBtn" id="btnR">▶</button>
</div>
<div class="btnGroup">
<button class="mBtn" id="btnUp">▲</button>
<button class="mBtn" id="btnJump">⬆</button>
</div>
</div>
</div>
<script>
(function(){
"use strict";
const C=document.getElementById('c'),X=C.getContext('2d');
const W=640,H=400;

// Colors
const COL={
bg:'#1a1a2e',wall:'#5c4033',plat:'#6b4423',player:'#e94560',
skin:'#ffcc99',rope:'#c8a84e',arrow:'#c0c0c0',fire:'#ff6600',
soldier:'#3366cc',bell:'#ffd700',esme:'#9b59b6',moon:'#fffde7'
};

// Game state
let state='start'; // start, playing, levelComplete, gameOver
let score=0, lives=3, level=1;
let shakeX=0, shakeY=0, shakeDur=0;
let particles=[];
let frameCount=0;
let fontLoaded=false;

// Check font
document.fonts.ready.then(()=>{fontLoaded=true});

// Stars
const stars=[];
for(let i=0;i<40;i++) stars.push({x:Math.random()*W,y:Math.random()*180,s:Math.random()*2+1,t:Math.random()*Math.PI*2,sp:Math.random()*0.03+0.01});

// Sound system
const AudioCtx=window.AudioContext||window.webkitAudioContext;
let actx=null;
function initAudio(){if(!actx)actx=new AudioCtx()}
function playTone(freq,freq2,dur,type,vol){
  if(!actx)return;
  const o=actx.createOscillator(),g=actx.createGain();
  o.type=type||'square';o.frequency.setValueAtTime(freq,actx.currentTime);
  if(freq2)o.frequency.linearRampToValueAtTime(freq2,actx.currentTime+dur);
  g.gain.setValueAtTime(vol||0.15,actx.currentTime);
  g.gain.linearRampToValueAtTime(0,actx.currentTime+dur);
  o.connect(g);g.connect(actx.destination);
  o.start();o.stop(actx.currentTime+dur);
}
function sfxJump(){playTone(400,600,0.15,'square',0.12)}
function sfxRope(){playTone(300,300,0.08,'square',0.08);setTimeout(()=>playTone(450,450,0.08,'square',0.08),40)}
function sfxHurt(){playTone(100,60,0.3,'sawtooth',0.2)}
function sfxScore(){playTone(523,523,0.1,'square',0.1);setTimeout(()=>playTone(659,659,0.1,'square',0.1),100);setTimeout(()=>playTone(784,784,0.15,'square',0.1),200)}
function sfxLevelComplete(){
  const notes=[523,587,659,698,784,880,988,1047];
  notes.forEach((n,i)=>setTimeout(()=>playTone(n,n,0.12,'square',0.1),i*80));
}
function sfxGameOver(){playTone(400,200,0.6,'sawtooth',0.18)}

// Input
const keys={};
document.addEventListener('keydown',e=>{
  keys[e.code]=true;
  if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code))e.preventDefault();
  if(state==='start'){initAudio();state='playing';resetLevel()}
  if(state==='gameOver'&&e.code==='Space'){score=0;lives=3;level=1;state='playing';resetLevel()}
  if(state==='levelComplete'&&e.code==='Space'){level++;state='playing';resetLevel()}
});
document.addEventListener('keyup',e=>{keys[e.code]=false});

// Mobile controls
const mobileKeys={btnL:'ArrowLeft',btnR:'ArrowRight',btnUp:'ArrowUp',btnJump:'Space'};
['btnL','btnR','btnUp','btnJump'].forEach(id=>{
  const el=document.getElementById(id);
  if(!el)return;
  const k=mobileKeys[id];
  el.addEventListener('touchstart',e=>{e.preventDefault();keys[k]=true;initAudio();
    if(state==='start'){state='playing';resetLevel()}
    if(state==='gameOver'){score=0;lives=3;level=1;state='playing';resetLevel()}
    if(state==='levelComplete'){level++;state='playing';resetLevel()}
  },{passive:false});
  el.addEventListener('touchend',e=>{e.preventDefault();keys[k]=false},{passive:false});
  el.addEventListener('touchcancel',e=>{keys[k]=false});
});

// Player
let player={x:40,y:300,vx:0,vy:0,w:20,h:24,onGround:false,onRope:null,ropePos:0,dir:1,frame:0,frameTimer:0,invuln:0,dead:false};
const SPEED=2.8, JUMP=-8.5, GRAV=0.45, FRIC=0.85;

// Level data
let platforms=[], ropes=[], arrows=[], fireballs=[], soldiers=[], bell={}, esme={};

function getLevelSpeedMul(){return level>5?1+((level-5)*0.2):1}

function resetLevel(){
  player.x=40;player.y=300;player.vx=0;player.vy=0;player.onGround=false;player.onRope=null;player.dir=1;player.dead=false;player.invuln=0;
  platforms=[];ropes=[];arrows=[];fireballs=[];soldiers=[];particles=[];
  const sm=getLevelSpeedMul();
  const lv=Math.min(level,5);

  // Base platforms always present
  // Ground
  platforms.push({x:0,y:370,w:640,h:30});

  if(lv===1){
    platforms.push({x:0,y:300,w:120,h:14});
    platforms.push({x:180,y:260,w:100,h:14});
    platforms.push({x:330,y:220,w:100,h:14});
    platforms.push({x:480,y:180,w:140,h:14});
    arrows.push({x:640,y:248,vx:-3.5*sm,w:30,h:6,startX:640});
    bell={x:580,y:148,r:14,t:0};
    esme={x:580,y:155,t:0};
  } else if(lv===2){
    platforms.push({x:0,y:300,w:100,h:14});
    platforms.push({x:200,y:280,w:80,h:14});
    platforms.push({x:420,y:260,w:80,h:14});
    platforms.push({x:540,y:200,w:100,h:14});
    ropes.push({x:160,topY:60,len:160,angle:0.8,speed:0.025*sm,ropeSpeed:0.025*sm});
    ropes.push({x:360,topY:50,len:170,angle:-0.5,speed:0.02*sm,ropeSpeed:0.02*sm});
    fireballs.push({cx:310,cy:300,r:60,angle:0,speed:0.03*sm,size:10});
    bell={x:590,y:168,r:14,t:0};
    esme={x:590,y:175,t:0};
  } else if(lv===3){
    platforms.push({x:0,y:300,w:150,h:14});
    platforms.push({x:200,y:300,w:240,h:14});
    platforms.push({x:490,y:300,w:150,h:14});
    platforms.push({x:490,y:200,w:150,h:14});
    soldiers.push({x:220,y:276,minX:200,maxX:420,vx:1.5*sm,w:20,h:24,dir:1});
    soldiers.push({x:500,y:276,minX:490,maxX:620,vx:1.2*sm,w:20,h:24,dir:1});
    arrows.push({x:640,y:285,vx:-4*sm,w:30,h:6,startX:640});
    bell={x:600,y:168,r:14,t:0};
    esme={x:600,y:175,t:0};
  } else if(lv===4){
    platforms.push({x:0,y:340,w:130,h:14});
    platforms.push({x:0,y:240,w:100,h:14});
    platforms.push({x:200,y:300,w:100,h:14});
    platforms.push({x:350,y:240,w:120,h:14});
    platforms.push({x:520,y:180,w:120,h:14});
    platforms.push({x:520,y:300,w:120,h:14});
    ropes.push({x:155,topY:40,len:150,angle:0.6,speed:0.022*sm,ropeSpeed:0.022*sm});
    ropes.push({x:470,topY:30,len:130,angle:-0.4,speed:0.028*sm,ropeSpeed:0.028*sm});
    soldiers.push({x:360,y:216,minX:350,maxX:450,vx:1.3*sm,w:20,h:24,dir:1});
    fireballs.push({cx:260,cy:200,r:50,angle:0,speed:0.025*sm,size:10});
    bell={x:580,y:148,r:14,t:0};
    esme={x:580,y:155,t:0};
    player.y=316;
  } else if(lv===5){
    platforms.push({x:0,y:340,w:100,h:14});
    platforms.push({x:0,y:240,w:80,h:14});
    platforms.push({x:180,y:300,w:80,h:14});
    platforms.push({x:300,y:250,w:80,h:14});
    platforms.push({x:420,y:200,w:80,h:14});
    platforms.push({x:540,y:160,w:100,h:14});
    ropes.push({x:130,topY:30,len:160,angle:0.7,speed:0.025*sm,ropeSpeed:0.025*sm});
    ropes.push({x:270,topY:20,len:170,angle:-0.3,speed:0.03*sm,ropeSpeed:0.03*sm});
    ropes.push({x:490,topY:10,len:140,angle:0.5,speed:0.027*sm,ropeSpeed:0.027*sm});
    arrows.push({x:640,y:285,vx:-4.5*sm,w:30,h:6,startX:640});
    arrows.push({x:640,y:190,vx:-3*sm,w:30,h:6,startX:640});
    soldiers.push({x:310,y:226,minX:300,maxX:370,vx:1.8*sm,w:20,h:24,dir:1});
    fireballs.push({cx:380,cy:300,r:55,angle:0,speed:0.035*sm,size:10});
    bell={x:590,y:128,r:14,t:0};
    esme={x:590,y:135,t:0};
    player.y=316;
  }
}

// Particle system
function spawnParticles(x,y,col,count){
  for(let i=0;i<count;i++){
    particles.push({x,y,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4-2,life:1,col,size:Math.random()*3+1});
  }
}

// Collision
function rectsOverlap(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y}

function hurtPlayer(){
  if(player.invuln>0||player.dead)return;
  lives--;
  sfxHurt();
  shakeX=0;shakeY=0;shakeDur=15;
  spawnParticles(player.x+player.w/2,player.y+player.h/2,'#e94560',12);
  player.invuln=90;
  if(lives<=0){
    player.dead=true;
    state='gameOver';
    sfxGameOver();
  } else {
    player.x=40;player.y=300;player.vx=0;player.vy=0;player.onRope=null;
    // Find lowest platform player starts on
    const startPlat=platforms.reduce((best,p)=>p.y<370&&p.x<=50?((!best||p.y>best.y)?p:best):best,null);
    if(startPlat){player.y=startPlat.y-player.h}else{player.y=346}
  }
}

// Update
function update(){
  if(state!=='playing')return;
  frameCount++;

  // Screen shake
  if(shakeDur>0){
    shakeDur--;
    shakeX=(Math.random()-0.5)*6;
    shakeY=(Math.random()-0.5)*6;
  } else {shakeX=0;shakeY=0}

  // Player invuln
  if(player.invuln>0)player.invuln--;

  // Player movement
  if(player.onRope!==null){
    // On rope
    const rope=ropes[player.onRope];
    if(!rope){player.onRope=null}
    else{
      // Climb up/down
      if(keys['ArrowUp']){player.ropePos=Math.max(0.15,player.ropePos-0.015)}
      if(keys['ArrowDown']){player.ropePos=Math.min(0.95,player.ropePos+0.015)}
      // Release
      if(keys['Space']){
        const bx=rope.x+Math.sin(rope.angle)*rope.len*player.ropePos;
        const by=rope.topY+Math.cos(rope.angle)*rope.len*player.ropePos;
        player.x=bx-player.w/2;
        player.y=by-player.h/2;
        // Momentum
        player.vx=Math.cos(rope.angle)*rope.speed*rope.len*player.ropePos*0.6;
        player.vy=-3.5;
        player.onRope=null;
        keys['Space']=false;
      }
    }
  } else {
    // Normal movement
    if(keys['ArrowLeft']){player.vx-=SPEED*0.3;player.dir=-1}
    if(keys['ArrowRight']){player.vx+=SPEED*0.3;player.dir=1}
    player.vx*=FRIC;
    if(Math.abs(player.vx)>SPEED)player.vx=SPEED*Math.sign(player.vx);
    player.vy+=GRAV;
    if(player.vy>10)player.vy=10;

    // Jump
    if(keys['Space']&&player.onGround){
      player.vy=JUMP;
      player.onGround=false;
      sfxJump();
      keys['Space']=false;
    }

    player.x+=player.vx;
    player.y+=player.vy;

    // Platform collision
    player.onGround=false;
    for(const p of platforms){
      if(player.x+player.w>p.x&&player.x<p.x+p.w){
        // Landing on top
        if(player.vy>=0&&player.y+player.h>=p.y&&player.y+player.h<=p.y+p.h+8){
          player.y=p.y-player.h;
          player.vy=0;
          player.onGround=true;
        }
      }
    }

    // Wall bounds
    if(player.x<0){player.x=0;player.vx=0}
    if(player.x+player.w>W){player.x=W-player.w;player.vx=0}
    if(player.y>H){hurtPlayer()}

    // Rope grab
    if(keys['ArrowUp']&&!player.onGround){
      for(let i=0;i<ropes.length;i++){
        const r=ropes[i];
        // Check distance to rope line
        for(let t=0.15;t<=0.95;t+=0.05){
          const rx=r.x+Math.sin(r.angle)*r.len*t;
          const ry=r.topY+Math.cos(r.angle)*r.len*t;
          const dx=player.x+player.w/2-rx;
          const dy=player.y+player.h/2-ry;
          if(Math.sqrt(dx*dx+dy*dy)<25){
            player.onRope=i;
            player.ropePos=t;
            player.vx=0;player.vy=0;
            sfxRope();
            keys['ArrowUp']=false;
            break;
          }
        }
        if(player.onRope!==null)break;
      }
    }
  }

  // Animation
  if(Math.abs(player.vx)>0.5&&player.onGround){
    player.frameTimer++;
    if(player.frameTimer>6){player.frameTimer=0;player.frame=(player.frame+1)%4}
  } else {player.frame=0;player.frameTimer=0}

  // Update ropes
  for(const r of ropes){
    r.angle+=r.speed;
    if(r.angle>1.1||r.angle<-1.1)r.speed=-r.speed;
  }

  // Update arrows
  for(const a of arrows){
    a.x+=a.vx;
    if(a.x+a.w<-20)a.x=W+20;
    if(a.x>W+20)a.x=-20-a.w;
    if(rectsOverlap(player,{x:a.x,y:a.y,w:a.w,h:a.h})&&player.onRope===null)hurtPlayer();
  }

  // Update fireballs
  for(const f of fireballs){
    f.angle+=f.speed;
    const fx=f.cx+Math.cos(f.angle)*f.r;
    const fy=f.cy+Math.sin(f.angle)*f.r;
    const dx=player.x+player.w/2-fx;
    const dy=player.y+player.h/2-fy;
    if(Math.sqrt(dx*dx+dy*dy)<f.size+10&&player.onRope===null)hurtPlayer();
  }

  // Update soldiers
  for(const s of soldiers){
    s.x+=s.vx*s.dir;
    if(s.x<=s.minX){s.dir=1}
    if(s.x+s.w>=s.maxX){s.dir=-1}
    if(rectsOverlap(player,{x:s.x-4,y:s.y,w:s.w+8,h:s.h})&&player.onRope===null)hurtPlayer();
  }

  // Bell collision
  const bx=bell.x,by=bell.y-bell.r;
  const dx=player.x+player.w/2-bx;
  const dy=player.y+player.h/2-by;
  if(Math.sqrt(dx*dx+dy*dy)<bell.r+12){
    state='levelComplete';
    score+=1000+(level*500);
    spawnParticles(bell.x,bell.y-bell.r,COL.bell,20);
    sfxScore();
    setTimeout(sfxLevelComplete,300);
  }

  // Particles
  bell.t+=0.05;
  esme.t+=0.05;
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.life-=0.025;
    if(p.life<=0)particles.splice(i,1);
  }
}

// Draw functions
function drawPixelChar(px,py,dir,frame,invuln){
  if(invuln>0&&Math.floor(invuln/4)%2===0)return;
  X.save();
  X.translate(px+10,py);
  if(dir<0)X.scale(-1,1);
  else X.translate(-10,0);

  // Body (hunchback shape)
  X.fillStyle=COL.player;
  // Torso
  X.fillRect(2,8,12,12);
  // Hunch
  X.fillRect(8,4,8,8);
  // Cape flow
  const capeOff=frame%2===1?1:0;
  X.fillRect(0,10+capeOff,4,10);
  X.fillRect(-2,14+capeOff,4,6);

  // Head
  X.fillStyle=COL.skin;
  X.fillRect(4,0,8,8);
  // Eye
  X.fillStyle='#222';
  X.fillRect(8,2,2,2);

  // Legs
  X.fillStyle='#6b3a2a';
  if(frame===0||frame===2){
    X.fillRect(4,20,4,4);
    X.fillRect(10,20,4,4);
  } else if(frame===1){
    X.fillRect(2,20,4,4);
    X.fillRect(12,20,4,4);
  } else {
    X.fillRect(6,20,4,4);
    X.fillRect(8,20,4,4);
  }

  // Arms
  X.fillStyle=COL.skin;
  X.fillRect(14,10,4,3);
  // Back arm
  X.fillRect(-2,10,4,3);

  X.restore();
}

function drawRope(r,idx){
  const segments=20;
  X.strokeStyle=COL.rope;
  X.lineWidth=3;
  X.beginPath();
  X.moveTo(r.x,r.topY);
  for(let i=1;i<=segments;i++){
    const t=i/segments;
    const rx=r.x+Math.sin(r.angle)*r.len*t;
    const ry=r.topY+Math.cos(r.angle)*r.len*t;
    X.lineTo(rx,ry);
  }
  X.stroke();
  // Knots
  for(let t=0.25;t<=0.75;t+=0.25){
    const kx=r.x+Math.sin(r.angle)*r.len*t;
    const ky=r.topY+Math.cos(r.angle)*r.len*t;
    X.fillStyle='#a08030';
    X.fillRect(kx-2,ky-2,4,4);
  }
  // Player on rope
  if(player.onRope===idx){
    const rpx=r.x+Math.sin(r.angle)*r.len*player.ropePos-player.w/2;
    const rpy=r.topY+Math.cos(r.angle)*r.len*player.ropePos-player.h/2;
    drawPixelChar(rpx,rpy,player.dir,0,player.invuln);
  }
}

function drawArrow(a){
  X.fillStyle=COL.arrow;
  X.fillRect(a.x,a.y,a.w,a.h);
  // Arrowhead
  X.beginPath();
  X.moveTo(a.x,a.y-4);
  X.lineTo(a.x-8,a.y+a.h/2);
  X.lineTo(a.x,a.y+a.h+4);
  X.fillStyle='#888';
  X.fill();
  // Fletching
  X.fillStyle='#cc4444';
  X.fillRect(a.x+a.w-6,a.y-2,6,2);
  X.fillRect(a.x+a.w-6,a.y+a.h,6,2);
}

function drawFireball(f){
  const fx=f.cx+Math.cos(f.angle)*f.r;
  const fy=f.cy+Math.sin(f.angle)*f.r;
  // Glow
  const grad=X.createRadialGradient(fx,fy,0,fx,fy,f.size*2.5);
  grad.addColorStop(0,'rgba(255,200,50,0.6)');
  grad.addColorStop(0.5,'rgba(255,102,0,0.3)');
  grad.addColorStop(1,'rgba(255,50,0,0)');
  X.fillStyle=grad;
  X.fillRect(fx-f.size*3,fy-f.size*3,f.size*6,f.size*6);
  // Core
  X.fillStyle='#ffcc33';
  X.beginPath();
  X.arc(fx,fy,f.size,0,Math.PI*2);
  X.fill();
  X.fillStyle=COL.fire;
  X.beginPath();
  X.arc(fx,fy,f.size*0.6,0,Math.PI*2);
  X.fill();
}

function drawSoldier(s){
  X.save();
  X.translate(s.x+s.w/2,s.y);
  if(s.dir<0)X.scale(-1,1);
  X.translate(-s.w/2,0);

  // Body
  X.fillStyle=COL.soldier;
  X.fillRect(2,6,16,14);
  // Helmet
  X.fillStyle='#555';
  X.fillRect(2,0,16,8);
  X.fillRect(6,-2,8,4);
  // Face
  X.fillStyle=COL.skin;
  X.fillRect(4,2,6,4);
  // Eye
  X.fillStyle='#222';
  X.fillRect(6,3,2,2);
  // Legs
  X.fillStyle='#444';
  X.fillRect(4,20,5,4);
  X.fillRect(11,20,5,4);
  // Spear
  X.fillStyle='#8B4513';
  X.fillRect(18,0,3,20);
  X.fillStyle='#aaa';
  X.beginPath();
  X.moveTo(19.5,-8);
  X.lineTo(16,-1);
  X.lineTo(23,-1);
  X.fill();

  X.restore();
}

function drawBell(b){
  const bx=b.x, by=b.y;
  const glow=0.5+0.5*Math.sin(b.t*3);
  // Glow
  X.save();
  X.globalAlpha=0.3+glow*0.3;
  const grad=X.createRadialGradient(bx,by-b.r,0,bx,by-b.r,b.r*3);
  grad.addColorStop(0,COL.bell);
  grad.addColorStop(1,'rgba(255,215,0,0)');
  X.fillStyle=grad;
  X.beginPath();
  X.arc(bx,by-b.r,b.r*3,0,Math.PI*2);
  X.fill();
  X.restore();
  // Bell shape
  X.fillStyle=COL.bell;
  X.beginPath();
  X.arc(bx,by-b.r,b.r,0,Math.PI,false);
  X.lineTo(bx-b.r-3,by);
  X.lineTo(bx+b.r+3,by);
  X.closePath();
  X.fill();
  // Clapper
  X.fillStyle='#b8860b';
  X.beginPath();
  X.arc(bx,by+2,3,0,Math.PI*2);
  X.fill();
  // Hook
  X.strokeStyle=COL.bell;
  X.lineWidth=2;
  X.beginPath();
  X.arc(bx,by-b.r*2+2,4,Math.PI,0);
  X.stroke();
}

function drawEsmeralda(e){
  const ex=e.x, ey=e.y;
  const wave=Math.sin(e.t*2);
  // Dress
  X.fillStyle=COL.esme;
  X.fillRect(ex-8,ey-10,16,18);
  X.fillRect(ex-10,ey,20,8);
  // Head
  X.fillStyle=COL.skin;
  X.fillRect(ex-5,ey-18,10,9);
  // Hair
  X.fillStyle='#2c1810';
  X.fillRect(ex-6,ey-20,12,6);
  X.fillRect(ex-7,ey-16,3,10);
  X.fillRect(ex+4,ey-16,3,10);
  // Eyes
  X.fillStyle='#222';
  X.fillRect(ex-3,ey-15,2,2);
  X.fillRect(ex+1,ey-15,2,2);
  // Waving arm
  X.fillStyle=COL.skin;
  const armY=ey-12+wave*3;
  X.fillRect(ex+8,armY,4,3);
  X.fillRect(ex+11,armY-3,3,3);
}

function drawBrickWall(px,py,pw,ph){
  X.fillStyle=COL.wall;
  X.fillRect(px,py,pw,ph);
  const bw=16,bh=8;
  X.strokeStyle='#4a3328';
  X.lineWidth=1;
  for(let row=0;row<Math.ceil(ph/bh);row++){
    const offset=(row%2)*bw/2;
    for(let col=-1;col<Math.ceil(pw/bw)+1;col++){
      const bx=px+col*bw+offset;
      const by=py+row*bh;
      if(bx<px+pw&&bx+bw>px&&by<py+ph&&by+bh>py){
        X.strokeRect(Math.max(bx,px),Math.max(by,py),
          Math.min(bw,px+pw-Math.max(bx,px)),Math.min(bh,py+ph-Math.max(by,py)));
      }
    }
  }
}

function drawBackground(){
  // Sky gradient
  const skyGrad=X.createLinearGradient(0,0,0,H);
  skyGrad.addColorStop(0,'#0d0d2b');
  skyGrad.addColorStop(0.5,'#1a1a3e');
  skyGrad.addColorStop(1,'#2a1a3a');
  X.fillStyle=skyGrad;
  X.fillRect(0,0,W,H);

  // Stars
  for(const s of stars){
    s.t+=s.sp;
    const alpha=0.4+0.6*Math.abs(Math.sin(s.t));
    X.fillStyle=`rgba(255,255,240,${alpha})`;
    X.fillRect(Math.floor(s.x),Math.floor(s.y),s.s,s.s);
  }

  // Moon
  const mx=520,my=60,mr=28;
  // Glow
  const moonGlow=X.createRadialGradient(mx,my,mr*0.5,mx,my,mr*3);
  moonGlow.addColorStop(0,'rgba(255,253,231,0.15)');
  moonGlow.addColorStop(1,'rgba(255,253,231,0)');
  X.fillStyle=moonGlow;
  X.beginPath();X.arc(mx,my,mr*3,0,Math.PI*2);X.fill();
  // Moon body
  X.fillStyle=COL.moon;
  X.beginPath();X.arc(mx,my,mr,0,Math.PI*2);X.fill();
  // Craters
  X.fillStyle='rgba(200,200,180,0.5)';
  X.beginPath();X.arc(mx-8,my-5,5,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(mx+6,my+8,4,0,Math.PI*2);X.fill();
  X.beginPath();X.arc(mx+2,my-10,3,0,Math.PI*2);X.fill();

  // Notre Dame silhouettes
  X.fillStyle='#0f0f25';
  // Left tower
  X.fillRect(20,200,35,170);
  X.fillRect(15,190,45,15);
  X.beginPath();X.moveTo(20,190);X.lineTo(37,160);X.lineTo(55,190);X.fill();
  // Right tower
  X.fillRect(70,220,30,150);
  X.fillRect(65,210,40,15);
  X.beginPath();X.moveTo(70,210);X.lineTo(85,185);X.lineTo(100,210);X.fill();
  // Center spire
  X.fillRect(43,230,15,140);
  X.beginPath();X.moveTo(43,230);X.lineTo(50,180);X.lineTo(58,230);X.fill();
  // Buttresses (right side)
  X.fillRect(530,260,25,110);
  X.fillRect(560,280,20,90);
  // Rose window hint
  X.fillStyle='#1a1a40';
  X.beginPath();X.arc(50,260,8,0,Math.PI*2);X.fill();
}

function drawPlatform(p){
  if(p.y>=370){
    // Ground - full brick wall
    drawBrickWall(p.x,p.y,p.w,p.h);
  } else {
    // Platform with top highlight
    X.fillStyle=COL.plat;
    X.fillRect(p.x,p.y,p.w,p.h);
    X.fillStyle='#7d5a30';
    X.fillRect(p.x,p.y,p.w,3);
    // Brick pattern
    X.strokeStyle='#5a3a18';
    X.lineWidth=0.5;
    const bw=12;
    for(let i=0;i<Math.ceil(p.w/bw);i++){
      X.strokeRect(p.x+i*bw,p.y,bw,p.h);
    }
    // Underside shadow
    X.fillStyle='rgba(0,0,0,0.3)';
    X.fillRect(p.x,p.y+p.h-3,p.w,3);
  }
}

function drawHUD(){
  X.save();
  X.setTransform(1,0,0,1,0,0); // Ignore shake
  // Score
  X.fillStyle='#fff';
  X.font='10px "Press Start 2P",monospace';
  X.textAlign='left';
  X.fillText('SCORE '+String(score).padStart(6,'0'),10,20);
  // Level
  X.textAlign='center';
  X.fillText('LEVEL '+level,W/2,20);
  // Lives (hearts)
  X.textAlign='right';
  X.fillStyle='#e94560';
  for(let i=0;i<lives;i++){
    const hx=W-20-i*22, hy=10;
    X.beginPath();
    X.moveTo(hx,hy+4);
    X.bezierCurveTo(hx,hy,hx-6,hy,hx-6,hy+4);
    X.bezierCurveTo(hx-6,hy+8,hx,hy+12,hx,hy+14);
    X.bezierCurveTo(hx,hy+12,hx+6,hy+8,hx+6,hy+4);
    X.bezierCurveTo(hx+6,hy,hx,hy,hx,hy+4);
    X.fill();
  }
  X.restore();
}

function drawStartScreen(){
  drawBackground();
  X.fillStyle='rgba(0,0,0,0.6)';
  X.fillRect(0,0,W,H);

  X.fillStyle=COL.bell;
  X.font='28px "Press Start 2P",monospace';
  X.textAlign='center';
  X.fillText('HUNCHBACK',W/2,130);

  X.fillStyle='#ccc';
  X.font='10px "Press Start 2P",monospace';
  X.fillText('HTML5 Canvas Clone',W/2,160);
  X.fillText('Amstrad CPC (1983)',W/2,180);

  // Animated Quasi
  const qy=220+Math.sin(frameCount*0.05)*5;
  drawPixelChar(W/2-10,qy,1,Math.floor(frameCount/10)%4,0);

  X.fillStyle='#fff';
  X.font='11px "Press Start 2P",monospace';
  const blink=Math.sin(frameCount*0.08)>0;
  if(blink)X.fillText('PRESS SPACE TO START',W/2,310);

  X.fillStyle='#888';
  X.font='8px "Press Start 2P",monospace';
  X.fillText('ARROWS: Move  SPACE: Jump',W/2,345);
  X.fillText('UP: Grab Rope  DOWN: Climb Down',W/2,360);
}

function drawGameOver(){
  X.fillStyle='rgba(0,0,0,0.7)';
  X.fillRect(0,0,W,H);

  X.fillStyle='#e94560';
  X.font='28px "Press Start 2P",monospace';
  X.textAlign='center';
  X.fillText('GAME OVER',W/2,160);

  X.fillStyle='#fff';
  X.font='12px "Press Start 2P",monospace';
  X.fillText('FINAL SCORE: '+score,W/2,210);

  X.fillStyle='#ccc';
  X.font='10px "Press Start 2P",monospace';
  const blink=Math.sin(frameCount*0.08)>0;
  if(blink)X.fillText('PRESS SPACE TO RETRY',W/2,270);
}

function drawLevelComplete(){
  X.fillStyle='rgba(0,0,0,0.6)';
  X.fillRect(0,0,W,H);

  X.fillStyle=COL.bell;
  X.font='22px "Press Start 2P",monospace';
  X.textAlign='center';
  X.fillText('LEVEL '+level,W/2,140);
  X.fillText('COMPLETE!',W/2,170);

  X.fillStyle='#fff';
  X.font='12px "Press Start 2P",monospace';
  X.fillText('SCORE: '+score,W/2,210);

  const blink=Math.sin(frameCount*0.08)>0;
  X.fillStyle='#ccc';
  X.font='10px "Press Start 2P",monospace';
  if(blink)X.fillText('PRESS SPACE TO CONTINUE',W/2,270);
}

// Main draw
function draw(){
  X.save();
  X.translate(shakeX,shakeY);

  drawBackground();

  // Platforms
  for(const p of platforms)drawPlatform(p);
  // Ropes
  ropes.forEach((r,i)=>drawRope(r,i));
  // Arrows
  for(const a of arrows)drawArrow(a);
  // Fireballs
  for(const f of fireballs)drawFireball(f);
  // Soldiers
  for(const s of soldiers)drawSoldier(s);
  // Bell & Esmeralda
  drawEsmeralda(esme);
  drawBell(bell);
  // Player (if not on rope, drawn there instead)
  if(player.onRope===null&&!player.dead)drawPixelChar(player.x,player.y,player.dir,player.frame,player.invuln);
  // Particles
  for(const p of particles){
    X.globalAlpha=p.life;
    X.fillStyle=p.col;
    X.fillRect(p.x,p.y,p.size,p.size);
  }
  X.globalAlpha=1;

  X.restore();

  // HUD always on top, no shake
  drawHUD();

  // Overlays
  if(state==='levelComplete')drawLevelComplete();
  if(state==='gameOver')drawGameOver();
}

// Game loop
function loop(){
  frameCount++;
  if(state==='start'){
    drawStartScreen();
  } else {
    update();
    draw();
  }
  requestAnimationFrame(loop);
}

loop();
})();
</script>
</body>
</html>
