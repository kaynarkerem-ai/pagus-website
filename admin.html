<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Pagus Menswear</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --color-black: #1a1a1a; --color-gold: #c9a962; --color-noble: #2c3e50; --font-display: 'Playfair Display', serif; --font-body: 'Montserrat', sans-serif; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-body); background: #f5f5f5; color: var(--color-black); min-height: 100vh; }

        /* HEADER */
        .admin-header { background: var(--color-noble); padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15); position: sticky; top: 0; z-index: 100; }
        .admin-logo { font-family: var(--font-display); color: #fff; font-size: 1.3rem; font-weight: 700; letter-spacing: 2px; }
        .admin-logo span { color: var(--color-gold); font-size: 0.75rem; display: block; font-family: var(--font-body); letter-spacing: 3px; font-weight: 400; }
        .admin-user { display: flex; align-items: center; gap: 15px; }
        .admin-user-name { color: var(--color-gold); font-size: 0.8rem; font-weight: 600; }
        .admin-logout { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 16px; font-size: 0.75rem; font-weight: 600; cursor: pointer; border-radius: 3px; font-family: var(--font-body); transition: 0.3s; }
        .admin-logout:hover { border-color: #e74c3c; color: #e74c3c; }
        .back-link { color: rgba(255,255,255,0.6); font-size: 0.8rem; text-decoration: none; }
        .back-link:hover { color: var(--color-gold); }

        /* AUTH GATE */
        .auth-gate { display: flex; justify-content: center; align-items: center; min-height: 80vh; }
        .auth-gate-card { background: #fff; padding: 50px 40px; border-radius: 8px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.08); max-width: 400px; width: 90%; }
        .auth-gate-card h2 { font-family: var(--font-display); color: var(--color-noble); margin-bottom: 10px; }
        .auth-gate-card p { color: #999; font-size: 0.9rem; margin-bottom: 25px; }
        .gate-input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.95rem; font-family: var(--font-body); margin-bottom: 12px; outline: none; }
        .gate-input:focus { border-color: var(--color-gold); }
        .gate-btn { width: 100%; padding: 14px; background: var(--color-noble); color: #fff; border: none; font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; border-radius: 4px; font-family: var(--font-body); }
        .gate-btn:hover { background: #1a252f; }
        .gate-error { color: #e74c3c; font-size: 0.85rem; margin-bottom: 10px; display: none; }
        .gate-divider { display: flex; align-items: center; gap: 15px; margin: 18px 0; color: #ccc; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; }
        .gate-divider::before, .gate-divider::after { content: ''; flex: 1; border-top: 1px solid #eee; }
        .google-btn { width: 100%; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem; font-weight: 600; cursor: pointer; font-family: var(--font-body); display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s; color: #333; }
        .google-btn:hover { background: #f8f8f8; border-color: #bbb; }
        .google-btn svg { width: 18px; height: 18px; }

        /* NAV TABS */
        .admin-tabs { background: #fff; border-bottom: 1px solid #eee; display: flex; padding: 0 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .admin-tab { padding: 16px 25px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; cursor: pointer; color: #aaa; border-bottom: 3px solid transparent; transition: 0.3s; background: none; border-top: none; border-left: none; border-right: none; font-family: var(--font-body); }
        .admin-tab.active { color: var(--color-noble); border-bottom-color: var(--color-gold); }
        .admin-tab:hover { color: var(--color-noble); }

        /* CONTENT */
        .admin-content { max-width: 1200px; margin: 0 auto; padding: 30px; }
        .panel { display: none; }
        .panel.active { display: block; }

        /* STATS BAR */
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px; color: #999; margin-bottom: 8px; }
        .stat-card .value { font-family: var(--font-display); font-size: 2rem; color: var(--color-noble); }

        /* PRICING TABLE */
        .pricing-controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .filter-select { padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px; font-family: var(--font-body); font-size: 0.85rem; outline: none; background: #fff; }
        .filter-select:focus { border-color: var(--color-gold); }
        .search-input { padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px; font-family: var(--font-body); font-size: 0.85rem; outline: none; width: 250px; }
        .search-input:focus { border-color: var(--color-gold); }
        .btn-gold { background: var(--color-gold); color: #fff; border: none; padding: 10px 20px; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-radius: 4px; font-family: var(--font-body); transition: 0.3s; }
        .btn-gold:hover { background: #b89952; }
        .btn-gold:disabled { opacity: 0.5; cursor: not-allowed; }

        .price-table { width: 100%; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .price-table th { background: var(--color-noble); color: #fff; padding: 14px 15px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; text-align: left; font-weight: 600; }
        .price-table td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.9rem; vertical-align: middle; }
        .price-table tr:hover td { background: #fafafa; }
        .price-table .product-name { font-weight: 600; color: var(--color-noble); }
        .price-table .cat-badge { font-size: 0.7rem; background: #f0f0f0; padding: 3px 8px; border-radius: 3px; color: #666; }
        .price-input { width: 90px; padding: 8px 10px; border: 1px solid #ddd; border-radius: 4px; font-family: var(--font-body); font-size: 0.85rem; text-align: right; outline: none; }
        .price-input:focus { border-color: var(--color-gold); box-shadow: 0 0 0 2px rgba(201,169,98,0.15); }
        .price-input.changed { border-color: var(--color-gold); background: #fffdf5; }
        .currency-select { padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; font-family: var(--font-body); }

        /* USERS TABLE */
        .users-table { width: 100%; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .users-table th { background: var(--color-noble); color: #fff; padding: 14px 15px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; text-align: left; font-weight: 600; }
        .users-table td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; }
        .users-table tr:hover td { background: #fafafa; }
        .role-select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; font-family: var(--font-body); }
        .role-badge { display: inline-block; padding: 3px 10px; border-radius: 3px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }
        .role-badge.admin { background: #2c3e50; color: #fff; }
        .role-badge.premium { background: var(--color-gold); color: #fff; }
        .role-badge.vip { background: #8e44ad; color: #fff; }
        .role-badge.standard { background: #ecf0f1; color: #666; }

        /* TOAST */
        .admin-toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-20px); background: var(--color-noble); color: #fff; padding: 12px 28px; border-radius: 8px; font-size: 0.9rem; font-weight: 600; z-index: 9999; opacity: 0; transition: opacity 0.3s, transform 0.3s; pointer-events: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .admin-toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 60px 20px; color: #aaa; }
        .empty-state h3 { font-family: var(--font-display); color: #ccc; font-size: 1.5rem; margin-bottom: 10px; }

        /* SAVE BAR */
        .save-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-noble); color: #fff; padding: 15px 30px; display: none; align-items: center; justify-content: space-between; z-index: 200; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); }
        .save-bar.visible { display: flex; }
        .save-bar .change-count { font-size: 0.9rem; }
        .save-bar .change-count strong { color: var(--color-gold); }
        .save-bar .save-actions { display: flex; gap: 10px; }
        .btn-save { background: var(--color-gold); color: var(--color-noble); border: none; padding: 10px 25px; font-weight: 700; font-size: 0.85rem; cursor: pointer; border-radius: 4px; font-family: var(--font-body); text-transform: uppercase; letter-spacing: 1px; }
        .btn-save:hover { background: #d4b366; }
        .btn-discard { background: transparent; border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 10px 20px; font-size: 0.85rem; cursor: pointer; border-radius: 4px; font-family: var(--font-body); }
        .btn-discard:hover { border-color: #e74c3c; color: #e74c3c; }

        @media (max-width: 768px) {
            .admin-content { padding: 15px; }
            .admin-tabs { padding: 0 10px; overflow-x: auto; }
            .admin-tab { padding: 14px 15px; font-size: 0.7rem; white-space: nowrap; }
            .price-table, .users-table { font-size: 0.8rem; display: block; overflow-x: auto; }
            .price-input { width: 70px; }
            .search-input { width: 100%; }
            .pricing-controls { flex-direction: column; }
            .stats-bar { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- AUTH GATE (shown when not logged in or not admin) -->
    <div id="authGate" class="auth-gate">
        <div class="auth-gate-card">
            <h2>PAGUS Admin</h2>
            <p>Login with your admin account</p>
            <div id="gateError" class="gate-error"></div>
            <input type="email" id="gateEmail" class="gate-input" placeholder="Email" autocomplete="email">
            <input type="password" id="gatePass" class="gate-input" placeholder="Password" autocomplete="current-password" onkeypress="if(event.key==='Enter')gateLogin()">
            <button class="gate-btn" onclick="gateLogin()" id="gateBtn">LOGIN</button>
            <div class="gate-divider">or</div>
            <button class="google-btn" onclick="gateGoogleLogin()">
                <svg viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- ADMIN UI (shown after auth) -->
    <div id="adminUI" style="display:none;">
        <header class="admin-header">
            <div class="admin-logo">
                PAGUS
                <span>Admin Panel</span>
            </div>
            <div class="admin-user">
                <a href="index.html" class="back-link">‚Üê Back to Site</a>
                <span class="admin-user-name" id="adminName">Admin</span>
                <button class="admin-logout" onclick="adminLogout()">Logout</button>
            </div>
        </header>

        <div class="admin-tabs">
            <button class="admin-tab active" onclick="switchPanel('pricing')">üí∞ Pricing</button>
            <button class="admin-tab" onclick="switchPanel('users')">üë• Users</button>
            <button class="admin-tab" onclick="switchPanel('stats')">üìä Overview</button>
        </div>

        <div class="admin-content">
            <!-- STATS PANEL -->
            <div class="panel" id="panelStats">
                <div class="stats-bar" id="statsBar">
                    <div class="stat-card"><div class="label">Total Products</div><div class="value" id="statProducts">-</div></div>
                    <div class="stat-card"><div class="label">Products with Prices</div><div class="value" id="statPriced">-</div></div>
                    <div class="stat-card"><div class="label">Registered Users</div><div class="value" id="statUsers">-</div></div>
                    <div class="stat-card"><div class="label">Categories</div><div class="value" id="statCats">-</div></div>
                </div>
            </div>

            <!-- PRICING PANEL -->
            <div class="panel active" id="panelPricing">
                <div class="pricing-controls">
                    <select class="filter-select" id="catFilter" onchange="renderPriceTable()">
                        <option value="">All Categories</option>
                    </select>
                    <input type="text" class="search-input" id="priceSearch" placeholder="Search product code..." oninput="renderPriceTable()">
                    <select class="currency-select" id="defaultCurrency">
                        <option value="EUR">EUR ‚Ç¨</option>
                        <option value="USD">USD $</option>
                        <option value="GBP">GBP ¬£</option>
                        <option value="TRY">TRY ‚Ç∫</option>
                    </select>
                    <button class="btn-gold" onclick="exportPrices()">Export CSV</button>
                </div>
                <div id="priceTableContainer"></div>
            </div>

            <!-- USERS PANEL -->
            <div class="panel" id="panelUsers">
                <div class="pricing-controls" style="margin-bottom:20px;">
                    <input type="text" class="search-input" id="userSearch" placeholder="Search users..." oninput="renderUsersTable()">
                </div>
                <div id="usersTableContainer"></div>
            </div>
        </div>

        <!-- SAVE BAR -->
        <div class="save-bar" id="saveBar">
            <div class="change-count"><strong id="changeCount">0</strong> unsaved price changes</div>
            <div class="save-actions">
                <button class="btn-discard" onclick="discardChanges()">Discard</button>
                <button class="btn-save" onclick="saveAllPrices()" id="saveBtn">Save All</button>
            </div>
        </div>
    </div>

    <div class="admin-toast" id="adminToast"></div>

    <script src="inventory.js?v=1771500808"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
    // ================================================================
    //  üî• FIREBASE CONFIG ‚Äî Aynƒ± config'i index.html'den kopyala
    // ================================================================
    var firebaseConfig = {
        apiKey: "AIzaSyAWiTFG-XRg7u_dY7G_jftrL5uIwq4vvWM",
        authDomain: "pagus-website.firebaseapp.com",
        projectId: "pagus-website",
        storageBucket: "pagus-website.firebasestorage.app",
        messagingSenderId: "181201607827",
        appId: "1:181201607827:web:7872bded476390a6754166"
    };

    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();
    var auth = firebase.auth();

    var _allPrices = {};     // productId -> { standard, premium, vip, currency }
    var _pendingChanges = {};  // productId -> { field: value }
    var _allUsers = [];

    // ===================== AUTH GATE =====================

    auth.onAuthStateChanged(function(user){
        if(user){
            checkAdminRole(user);
        } else {
            document.getElementById('authGate').style.display = 'flex';
            document.getElementById('adminUI').style.display = 'none';
        }
    });

    function checkAdminRole(user){
        db.collection('users').doc(user.uid).get().then(function(doc){
            if(doc.exists && doc.data().role === 'admin'){
                showAdminUI(user);
            } else {
                showGateError('Access denied. Admin role required.');
                auth.signOut();
            }
        }).catch(function(e){
            showGateError('Error checking permissions: ' + e.message);
        });
    }

    function showAdminUI(user){
        document.getElementById('authGate').style.display = 'none';
        document.getElementById('adminUI').style.display = 'block';
        document.getElementById('adminName').textContent = user.displayName || user.email;
        initAdmin();
    }

    function gateLogin(){
        var email = document.getElementById('gateEmail').value.trim();
        var pass = document.getElementById('gatePass').value;
        if(!email || !pass){ showGateError('Enter email and password.'); return; }

        var btn = document.getElementById('gateBtn');
        btn.disabled = true; btn.textContent = 'LOGGING IN...';

        auth.signInWithEmailAndPassword(email, pass)
            .catch(function(e){
                var msg = 'Login failed.';
                if(e.code === 'auth/user-not-found' || e.code === 'auth/wrong-password' || e.code === 'auth/invalid-credential') msg = 'Invalid email or password.';
                showGateError(msg);
            })
            .finally(function(){ btn.disabled = false; btn.textContent = 'LOGIN'; });
    }

    function showGateError(msg){
        var el = document.getElementById('gateError');
        el.textContent = msg;
        el.style.display = 'block';
    }

    function adminLogout(){
        auth.signOut();
    }

    function gateGoogleLogin(){
        var provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .then(function(result){
                var user = result.user;
                var isNew = result.additionalUserInfo && result.additionalUserInfo.isNewUser;
                if(isNew){
                    db.collection('users').doc(user.uid).set({
                        displayName: user.displayName || user.email.split('@')[0],
                        email: user.email,
                        role: 'standard',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                // onAuthStateChanged will handle the rest
            })
            .catch(function(e){
                if(e.code === 'auth/popup-closed-by-user') return;
                showGateError('Google login failed: ' + e.message);
            });
    }

    // ===================== ADMIN INIT =====================

    function initAdmin(){
        populateCategoryFilter();
        loadAllPrices();
        loadAllUsers();
        loadStats();
    }

    function populateCategoryFilter(){
        if(typeof productsDB === 'undefined') return;
        var cats = [...new Set(productsDB.map(function(p){
            return p.category.indexOf(' > ') > -1 ? p.category.split(' > ')[0] : p.category;
        }))].sort();

        var sel = document.getElementById('catFilter');
        cats.forEach(function(c){
            var opt = document.createElement('option');
            opt.value = c; opt.textContent = c;
            sel.appendChild(opt);
        });
    }

    // ===================== PRICING =====================

    function loadAllPrices(){
        db.collection('pricing').get().then(function(snap){
            _allPrices = {};
            snap.forEach(function(doc){
                _allPrices[doc.id] = doc.data();
            });
            renderPriceTable();
        }).catch(function(e){
            adminToast('Error loading prices: ' + e.message);
        });
    }

    function renderPriceTable(){
        if(typeof productsDB === 'undefined'){
            document.getElementById('priceTableContainer').innerHTML = '<div class="empty-state"><h3>No Products</h3><p>inventory.js not found.</p></div>';
            return;
        }

        var catFilter = document.getElementById('catFilter').value;
        var searchQ = document.getElementById('priceSearch').value.toLowerCase().trim();

        var filtered = productsDB.filter(function(p){
            var mainCat = p.category.indexOf(' > ') > -1 ? p.category.split(' > ')[0] : p.category;
            if(catFilter && mainCat !== catFilter) return false;
            if(searchQ && p.id.toLowerCase().indexOf(searchQ) === -1 && p.category.toLowerCase().indexOf(searchQ) === -1) return false;
            return true;
        });

        if(filtered.length === 0){
            document.getElementById('priceTableContainer').innerHTML = '<div class="empty-state"><h3>No Results</h3><p>Try different filters.</p></div>';
            return;
        }

        var html = '<table class="price-table"><thead><tr>'
            + '<th>Product Code</th><th>Category</th>'
            + '<th>Standard (‚Ç¨)</th><th>Premium (‚Ç¨)</th><th>VIP (‚Ç¨)</th>'
            + '<th>Currency</th>'
            + '</tr></thead><tbody>';

        filtered.forEach(function(p){
            var prices = _allPrices[p.id] || {};
            var pending = _pendingChanges[p.id] || {};
            var std = pending.standard !== undefined ? pending.standard : (prices.standard || '');
            var prem = pending.premium !== undefined ? pending.premium : (prices.premium || '');
            var vip = pending.vip !== undefined ? pending.vip : (prices.vip || '');
            var curr = pending.currency || prices.currency || 'EUR';

            var stdChanged = pending.standard !== undefined ? ' changed' : '';
            var premChanged = pending.premium !== undefined ? ' changed' : '';
            var vipChanged = pending.vip !== undefined ? ' changed' : '';

            html += '<tr>'
                + '<td class="product-name">' + escapeHTML(p.id) + '</td>'
                + '<td><span class="cat-badge">' + escapeHTML(p.category) + '</span></td>'
                + '<td><input class="price-input' + stdChanged + '" type="number" step="0.01" min="0" value="' + std + '" data-pid="' + escapeAttr(p.id) + '" data-tier="standard" onchange="onPriceChange(this)"></td>'
                + '<td><input class="price-input' + premChanged + '" type="number" step="0.01" min="0" value="' + prem + '" data-pid="' + escapeAttr(p.id) + '" data-tier="premium" onchange="onPriceChange(this)"></td>'
                + '<td><input class="price-input' + vipChanged + '" type="number" step="0.01" min="0" value="' + vip + '" data-pid="' + escapeAttr(p.id) + '" data-tier="vip" onchange="onPriceChange(this)"></td>'
                + '<td><select class="currency-select" data-pid="' + escapeAttr(p.id) + '" onchange="onCurrencyChange(this)">'
                + '<option value="EUR"' + (curr==='EUR'?' selected':'') + '>EUR</option>'
                + '<option value="USD"' + (curr==='USD'?' selected':'') + '>USD</option>'
                + '<option value="GBP"' + (curr==='GBP'?' selected':'') + '>GBP</option>'
                + '<option value="TRY"' + (curr==='TRY'?' selected':'') + '>TRY</option>'
                + '</select></td>'
                + '</tr>';
        });

        html += '</tbody></table>';
        html += '<p style="text-align:center;color:#999;font-size:0.8rem;margin-top:15px;">Showing ' + filtered.length + ' of ' + productsDB.length + ' products</p>';
        document.getElementById('priceTableContainer').innerHTML = html;
    }

    function onPriceChange(input){
        var pid = input.dataset.pid;
        var tier = input.dataset.tier;
        var val = input.value.trim();

        if(!_pendingChanges[pid]) _pendingChanges[pid] = {};

        if(val === '' || val === null){
            _pendingChanges[pid][tier] = '';
        } else {
            _pendingChanges[pid][tier] = parseFloat(val);
        }

        input.classList.add('changed');
        updateSaveBar();
    }

    function onCurrencyChange(sel){
        var pid = sel.dataset.pid;
        if(!_pendingChanges[pid]) _pendingChanges[pid] = {};
        _pendingChanges[pid].currency = sel.value;
        updateSaveBar();
    }

    function updateSaveBar(){
        var count = Object.keys(_pendingChanges).length;
        document.getElementById('changeCount').textContent = count;
        document.getElementById('saveBar').classList.toggle('visible', count > 0);
    }

    function discardChanges(){
        _pendingChanges = {};
        updateSaveBar();
        renderPriceTable();
        adminToast('Changes discarded.');
    }

    function saveAllPrices(){
        var pids = Object.keys(_pendingChanges);
        if(pids.length === 0) return;

        var btn = document.getElementById('saveBtn');
        btn.disabled = true; btn.textContent = 'SAVING...';

        var batch = db.batch();
        pids.forEach(function(pid){
            var changes = _pendingChanges[pid];
            var existing = _allPrices[pid] || {};
            var merged = Object.assign({}, existing, changes);

            // Clean empty values
            ['standard', 'premium', 'vip'].forEach(function(tier){
                if(merged[tier] === '' || merged[tier] === null || merged[tier] === undefined){
                    delete merged[tier];
                }
            });

            if(!merged.currency) merged.currency = 'EUR';
            merged.updatedAt = firebase.firestore.FieldValue.serverTimestamp();

            batch.set(db.collection('pricing').doc(pid), merged, { merge: true });
            _allPrices[pid] = merged;
        });

        batch.commit().then(function(){
            _pendingChanges = {};
            updateSaveBar();
            renderPriceTable();
            loadStats();
            adminToast('‚úì ' + pids.length + ' prices saved successfully!');
        }).catch(function(e){
            adminToast('Error saving: ' + e.message);
        }).finally(function(){
            btn.disabled = false; btn.textContent = 'Save All';
        });
    }

    function exportPrices(){
        if(typeof productsDB === 'undefined') return;
        var rows = [['Product Code', 'Category', 'Standard', 'Premium', 'VIP', 'Currency']];
        productsDB.forEach(function(p){
            var pr = _allPrices[p.id] || {};
            rows.push([p.id, p.category, pr.standard || '', pr.premium || '', pr.vip || '', pr.currency || 'EUR']);
        });
        var csv = rows.map(function(r){ return r.map(function(v){ return '"' + String(v).replace(/"/g, '""') + '"'; }).join(','); }).join('\n');
        var blob = new Blob([csv], { type: 'text/csv' });
        var a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'pagus_prices_' + new Date().toISOString().slice(0,10) + '.csv';
        a.click();
        adminToast('CSV exported!');
    }

    // ===================== USERS =====================

    function loadAllUsers(){
        db.collection('users').orderBy('createdAt', 'desc').get().then(function(snap){
            _allUsers = [];
            snap.forEach(function(doc){
                _allUsers.push(Object.assign({ uid: doc.id }, doc.data()));
            });
            renderUsersTable();
        }).catch(function(e){
            adminToast('Error loading users: ' + e.message);
        });
    }

    function renderUsersTable(){
        var searchQ = (document.getElementById('userSearch').value || '').toLowerCase().trim();

        var filtered = _allUsers.filter(function(u){
            if(!searchQ) return true;
            return (u.displayName || '').toLowerCase().indexOf(searchQ) > -1
                || (u.email || '').toLowerCase().indexOf(searchQ) > -1;
        });

        if(filtered.length === 0){
            document.getElementById('usersTableContainer').innerHTML = '<div class="empty-state"><h3>No Users</h3><p>No registered users yet, or no results for your search.</p></div>';
            return;
        }

        var html = '<table class="users-table"><thead><tr>'
            + '<th>Name</th><th>Email</th><th>Role</th><th>Registered</th><th>Action</th>'
            + '</tr></thead><tbody>';

        filtered.forEach(function(u){
            var dateStr = u.createdAt ? new Date(u.createdAt.seconds * 1000).toLocaleDateString() : '-';
            var role = u.role || 'standard';
            html += '<tr>'
                + '<td><strong>' + escapeHTML(u.displayName || '-') + '</strong></td>'
                + '<td>' + escapeHTML(u.email || '-') + '</td>'
                + '<td><span class="role-badge ' + escapeAttr(role) + '">' + escapeHTML(role) + '</span></td>'
                + '<td>' + dateStr + '</td>'
                + '<td><select class="role-select" data-uid="' + escapeAttr(u.uid) + '" onchange="changeUserRole(this)">'
                + '<option value="standard"' + (role==='standard'?' selected':'') + '>Standard</option>'
                + '<option value="premium"' + (role==='premium'?' selected':'') + '>Premium</option>'
                + '<option value="vip"' + (role==='vip'?' selected':'') + '>VIP</option>'
                + '<option value="admin"' + (role==='admin'?' selected':'') + '>Admin</option>'
                + '</select></td>'
                + '</tr>';
        });

        html += '</tbody></table>';
        html += '<p style="text-align:center;color:#999;font-size:0.8rem;margin-top:15px;">Total: ' + filtered.length + ' users</p>';
        document.getElementById('usersTableContainer').innerHTML = html;
    }

    function changeUserRole(sel){
        var uid = sel.dataset.uid;
        var newRole = sel.value;
        db.collection('users').doc(uid).update({ role: newRole }).then(function(){
            // Update local cache
            _allUsers.forEach(function(u){ if(u.uid === uid) u.role = newRole; });
            renderUsersTable();
            adminToast('Role updated to ' + newRole);
        }).catch(function(e){
            adminToast('Error: ' + e.message);
        });
    }

    // ===================== STATS =====================

    function loadStats(){
        document.getElementById('statProducts').textContent = typeof productsDB !== 'undefined' ? productsDB.length : 0;

        var pricedCount = 0;
        if(typeof productsDB !== 'undefined'){
            productsDB.forEach(function(p){
                if(_allPrices[p.id] && _allPrices[p.id].standard) pricedCount++;
            });
        }
        document.getElementById('statPriced').textContent = pricedCount;

        var cats = typeof productsDB !== 'undefined' ?
            [...new Set(productsDB.map(function(p){ return p.category.indexOf(' > ') > -1 ? p.category.split(' > ')[0] : p.category; }))].length : 0;
        document.getElementById('statCats').textContent = cats;

        // Users count
        db.collection('users').get().then(function(snap){
            document.getElementById('statUsers').textContent = snap.size;
        }).catch(function(){
            document.getElementById('statUsers').textContent = '?';
        });
    }

    // ===================== UI HELPERS =====================

    function switchPanel(name){
        document.querySelectorAll('.panel').forEach(function(p){ p.classList.remove('active'); });
        document.querySelectorAll('.admin-tab').forEach(function(t){ t.classList.remove('active'); });

        var panel = document.getElementById('panel' + name.charAt(0).toUpperCase() + name.slice(1));
        if(panel) panel.classList.add('active');

        // Find the tab button
        var tabs = document.querySelectorAll('.admin-tab');
        tabs.forEach(function(t){
            if(t.textContent.toLowerCase().indexOf(name) > -1) t.classList.add('active');
        });

        if(name === 'stats') loadStats();
        if(name === 'users') loadAllUsers();
    }

    function adminToast(msg){
        var t = document.getElementById('adminToast');
        t.textContent = msg;
        t.classList.add('visible');
        clearTimeout(window._adminToastTimer);
        window._adminToastTimer = setTimeout(function(){ t.classList.remove('visible'); }, 3000);
    }

    function escapeHTML(s){
        if(!s) return '';
        return String(s).replace(/[&<>'"]/g, function(t){
            return {'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[t];
        });
    }

    function escapeAttr(s){
        if(!s) return '';
        return String(s).replace(/[&<>"'`=\/]/g, function(t){
            return '&#' + t.charCodeAt(0) + ';';
        });
    }
    </script>
</body>
</html>
